<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2026 Strategy Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --dt:#003336;--t:#27A8AF;--tl:#E6F6F7;--td:#005A5E;
  --ch:#424242;--nv:#39436e;--nl:#ECEEF5;--nd:#1E2545;
  --go:#D9BC52;--gl:#FDF7E3;--gd:#A07E00;
  --mn:#DCECEC;--gr:#F7F6F4;--wh:#FFFFFF;
  --fd:'DM Serif Display',serif;--fb:'DM Sans',sans-serif;
  --r:10px;--sh:0 2px 16px rgba(0,51,54,.09);--shl:0 6px 32px rgba(0,51,54,.14)
}
html,body{height:100%;font-family:var(--fb);background:var(--gr);color:var(--ch);font-size:14px;line-height:1.5}
.app{display:flex;flex-direction:column;min-height:100vh}

/* HEADER */
header{background:var(--dt);height:60px;padding:0 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;box-shadow:0 2px 16px rgba(0,0,0,.2)}
nav{display:flex;gap:3px}
nav button{background:none;border:none;font-family:var(--fb);font-size:.78rem;font-weight:500;letter-spacing:.07em;text-transform:uppercase;color:rgba(255,255,255,.5);padding:6px 14px;border-radius:6px;cursor:pointer;transition:all .15s}
nav button:hover{color:var(--wh);background:rgba(255,255,255,.07)}
nav button.active{color:var(--dt);background:var(--t);font-weight:600}
.hdr-r{display:flex;align-items:center;gap:10px}
.hdr-sel{background:rgba(255,255,255,.09);border:1px solid rgba(255,255,255,.18);color:var(--wh);font-family:var(--fb);font-size:.82rem;font-weight:600;padding:5px 10px;border-radius:6px;cursor:pointer;outline:none}
.hdr-auth{display:flex;align-items:center;gap:5px;font-size:.73rem;color:rgba(255,255,255,.55);cursor:pointer;padding:4px 10px;border-radius:6px;transition:all .14s}
.hdr-auth:hover{background:rgba(255,255,255,.08)}
.hdr-dot{width:7px;height:7px;border-radius:50%;background:#4ade80}
.hdr-dot.off{background:#888}
.save-indicator{font-size:.68rem;color:rgba(255,255,255,.35);padding:3px 8px;border-radius:4px;transition:all .3s;white-space:nowrap}
.save-indicator.saving{color:var(--go)}
.save-indicator.saved{color:#4ade80}
.save-indicator.error{color:#f87171}

/* MAIN */
main{flex:1;padding:28px 32px;max-width:1280px;margin:0 auto;width:100%}
.view{display:none;animation:fu .2s ease}
.view.active{display:block}
@keyframes fu{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}

/* SHARED */
.pg-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;gap:16px}
.pg-title{font-family:var(--fd);font-size:1.6rem;color:var(--dt)}
.pg-sub{font-size:.8rem;color:#999;margin-top:2px}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 15px;border-radius:7px;font-family:var(--fb);font-size:.81rem;font-weight:600;cursor:pointer;border:none;transition:all .14s;white-space:nowrap}
.btn-p{background:var(--t);color:var(--wh)}.btn-p:hover{background:var(--td)}
.btn-g{background:none;border:1.5px solid var(--mn);color:var(--dt)}.btn-g:hover{border-color:var(--t);background:var(--tl)}
.btn-sm{padding:3px 10px;font-size:.73rem}
.btn-ic{background:none;border:none;cursor:pointer;color:#ccc;padding:2px 4px;border-radius:3px;font-size:.85rem}.btn-ic:hover{color:var(--ch)}
.wk-badge{display:inline-flex;align-items:center;font-size:.68rem;font-weight:600;color:#888;background:#f0f0f0;border-radius:4px;padding:2px 7px;cursor:pointer;white-space:nowrap;flex-shrink:0;border:1px solid #e4e4e4;transition:background .15s}.wk-badge:hover{background:#e4e4e4;color:var(--t)}.wk-badge.past{color:#c0392b;background:#fdf0ee;border-color:#f5c6c0}
.dot-xl{width:14px;height:14px;border-radius:50%;flex-shrink:0}
.dot-lg{width:11px;height:11px;border-radius:50%;flex-shrink:0}
.dot-sm{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.chip{border-radius:5px;padding:2px 8px;font-size:.69rem;font-weight:600;white-space:nowrap;flex-shrink:0}
.chip.ns{background:#e8e8e8;color:#555}.chip.ip{background:#FFF3CD;color:#7D5A00}
.chip.cp{background:#D6F0E0;color:#1A7A4A}.chip.oh{background:#FFE4E4;color:#b22222}
.sel{border:1.5px solid var(--mn);border-radius:6px;padding:3px 7px;font-family:var(--fb);font-size:.72rem;font-weight:600;cursor:pointer;outline:none;background:var(--wh)}
.sel.ns{color:#555;background:#e8e8e8;border-color:#ccc}.sel.ip{color:#7D5A00;background:#FFF3CD;border-color:#daa520}
.sel.cp{color:#1A7A4A;background:#D6F0E0;border-color:#1A7A4A}.sel.oh{color:#b22222;background:#FFE4E4;border-color:#b22222}

/* ── PLAN ── */
.plan-goals{display:grid;gap:18px}
.gc{background:var(--wh);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden}
.gc-hdr{padding:16px 22px 12px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;border-bottom:1px solid var(--gr)}
.gc-num{font-size:.64rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#bbb;margin-bottom:3px}
.gc-title{font-family:var(--fd);font-size:1.08rem;color:var(--dt);line-height:1.3}
.sb{border-bottom:1px solid var(--gr)}.sb:last-child{border-bottom:none}
.sh{padding:9px 22px;display:flex;align-items:center;justify-content:space-between;background:#f9f9f9;border-bottom:1px solid var(--gr)}
.qb{font-size:.7rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:3px 8px;border-radius:4px;flex-shrink:0}
.so{font-size:.82rem;color:#666;font-style:italic;margin-left:10px;flex:1}
.db{border-bottom:1px solid #f0f0f0}.db:last-child{border-bottom:none}
.dh{padding:8px 22px 8px 28px;display:flex;align-items:center;gap:8px;background:#fafafa;border-bottom:1px solid #f0f0f0;border-left:4px solid transparent}
.dt2{font-size:.82rem;font-weight:600;color:var(--dt);flex:1}
.tl-p{padding:2px 0 4px}.tr-p{display:flex;align-items:center;gap:8px;padding:5px 22px 5px 46px;border-bottom:1px solid #f7f7f7}
.tr-p:last-of-type{border-bottom:none}.tt-p{flex:1;font-size:.8rem;color:var(--ch);line-height:1.4}
.add-r{padding:4px 22px 8px 46px}

/* ── STRATEGY MAP ── */
.mb{background:var(--wh);border-radius:var(--r);box-shadow:var(--sh);padding:13px 18px;margin-bottom:20px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.mb-lbl{font-size:.68rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;margin-right:4px;white-space:nowrap}
.qg{display:flex;align-items:center;gap:5px}
.ql{font-size:.64rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:2px 7px;border-radius:3px;white-space:nowrap}
.mp{padding:5px 12px;border-radius:18px;font-family:var(--fb);font-size:.76rem;font-weight:500;cursor:pointer;border:1.5px solid #ddd;background:var(--wh);color:#999;transition:all .14s;white-space:nowrap}
.mp:hover{border-color:var(--t);color:var(--dt)}.mp.active{background:var(--dt);color:var(--wh);border-color:var(--dt);font-weight:600}.mp.hd{color:var(--ch);border-color:#ccc}
.qdiv{width:1px;height:24px;background:#ddd;margin:0 2px}
.map-wrap{overflow-x:auto}
.map-tbl{width:100%;min-width:820px;border-collapse:separate;border-spacing:0;border-radius:var(--r);overflow:hidden;box-shadow:var(--shl)}
.map-tbl th{background:var(--dt);color:var(--wh);font-size:.68rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:11px 16px;text-align:left}
.map-tbl td{padding:14px;vertical-align:top;border-bottom:1px solid rgba(0,0,0,.04);background:var(--wh)}
.map-tbl tr:last-child td{border-bottom:none}
.map-gn{font-size:.58rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;margin-bottom:3px}
.map-gt{font-family:var(--fd);font-size:.95rem;line-height:1.33}
.map-qo{font-size:.82rem;line-height:1.4;font-style:italic;color:rgba(255,255,255,.9)}
.map-di{display:flex;align-items:center;gap:7px;padding:4px 0;border-bottom:1px solid rgba(0,0,0,.04)}.map-di:last-child{border-bottom:none}
.map-dt2{font-size:.8rem;color:var(--ch);line-height:1.33}
.map-tg{margin-bottom:3px}.map-ti{display:flex;align-items:center;gap:6px;padding:3px 0}
.map-tt{flex:1;font-size:.78rem;color:var(--ch);line-height:1.4}.map-tdiv{height:1px;background:#f0f0f0;margin:3px 0}
.no-data{font-size:.78rem;color:#ccc;font-style:italic;padding:4px 0}

/* ── WEEKLY REVIEW ── */
.w-bar{background:var(--dt);border-radius:var(--r);padding:17px 24px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between}
.w-week{font-family:var(--fd);font-size:1.3rem;color:var(--wh)}
.w-stats{display:flex;gap:20px}
.wsn{font-family:var(--fd);font-size:1.65rem;line-height:1}
.wsl{font-size:.66rem;color:rgba(255,255,255,.45);text-transform:uppercase;letter-spacing:.08em;margin-top:2px}

/* Summary strip */
.sum-strip{background:var(--wh);border-radius:var(--r);box-shadow:var(--sh);padding:13px 22px;margin-bottom:20px;display:flex;align-items:center;flex-wrap:wrap;gap:0}
.sum-lbl{font-size:.66rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:#bbb;margin-right:14px;white-space:nowrap}
.sum-body{display:flex;align-items:center;gap:14px;flex-wrap:wrap;flex:1}
.sum-stat{display:flex;align-items:center;gap:5px;padding-right:14px;border-right:1px solid #eee}
.sum-stat:last-child{border-right:none;padding-right:0}
.sum-n{font-family:var(--fd);font-size:1.05rem;color:var(--dt)}
.sum-t{font-size:.76rem;color:#999}
.gpill{display:flex;align-items:center;gap:5px;border-radius:20px;padding:3px 10px}
.gpill-d{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.gpill-l{font-size:.73rem;font-weight:600}

/* Goal cards */
.w-goals{display:grid;gap:16px}
.wgc{background:var(--wh);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden}
.wgb{padding:12px 20px;display:flex;align-items:center;gap:8px}
.wgt{font-family:var(--fd);font-size:.96rem;color:var(--wh);flex:1}
.wpw{display:flex;align-items:center;gap:6px;flex-shrink:0}
.wpp{font-size:.7rem;color:rgba(255,255,255,.75);font-weight:600}
.wpb{width:52px;height:3px;background:rgba(255,255,255,.2);border-radius:2px;overflow:hidden}
.wpf{height:100%;background:rgba(255,255,255,.82);border-radius:2px}

/* Strategy row */
.str-row{padding:7px 20px;display:flex;align-items:center;gap:8px;background:#f4fafa;border-bottom:1px solid #e8f0f0;border-left:3px solid var(--t)}
.str-qb{font-size:.66rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:2px 7px;border-radius:3px;flex-shrink:0}
.str-obj{font-size:.79rem;color:#555;font-style:italic}

/* Deliverable groups */
.wdg{border-bottom:1px solid var(--gr)}.wdg:last-child{border-bottom:none}
.wdh{padding:8px 20px;display:flex;align-items:center;gap:8px;background:#fafafa;border-bottom:1px solid var(--gr);border-left:4px solid transparent}
.wdt{font-size:.82rem;font-weight:600;color:var(--dt);flex:1}

/* Task rows */
.wtl{padding:2px 0}.wtr{display:flex;align-items:center;gap:9px;padding:7px 20px;border-bottom:1px solid #f5f5f5;transition:background .1s}
.wtr:last-child{border-bottom:none}.wtr:hover{background:var(--gr)}
.wck{width:17px;height:17px;border-radius:4px;border:2px solid #ccc;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .14s;background:var(--wh)}
.wck.cp{border-color:#1A7A4A;background:#1A7A4A}.wck.ip{background:#FFF3CD;border-color:#daa520}
.wck svg{display:none}.wck.cp svg{display:block}
.wtt{flex:1;font-size:.82rem;color:var(--ch);line-height:1.4}

/* Recurring tasks */
.wtr.rec{background:#faffff}.wtr.rec:hover{background:var(--tl)}
.rec-badge{font-size:.6rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;padding:2px 6px;border-radius:3px;flex-shrink:0}
.rec-wrap{display:flex;align-items:center;gap:5px;flex-shrink:0}
.rec-inp{width:42px;text-align:center;padding:3px 5px;border:1.5px solid #ccc;border-radius:6px;font-family:var(--fd);font-size:.96rem;color:var(--dt);outline:none;transition:border-color .14s;background:var(--wh)}
.rec-inp:focus{border-color:var(--t)}.rec-inp.over{border-color:#1A7A4A;background:#D6F0E0;color:#1A7A4A}.rec-inp.under{border-color:#daa520;background:#FFF3CD;color:#7D5A00}
.rec-target{font-size:.73rem;color:#aaa;white-space:nowrap}
.rec-status{font-size:.72rem;font-weight:600;white-space:nowrap}
.rec-status.over{color:#1A7A4A}.rec-status.under{color:#daa520}.rec-status.none{color:#ccc}

/* ── SCORECARD ── */
.sc-grid{display:grid;gap:20px}
.scc{background:var(--wh);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden}
.sch{padding:17px 22px 13px;border-bottom:1px solid var(--gr)}
.sc-lbl{font-size:.64rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#bbb;margin-bottom:3px}
.sc-title{font-family:var(--fd);font-size:1.08rem;color:var(--dt);line-height:1.3;margin-bottom:11px}
.sc-pr{display:flex;align-items:center;gap:11px}
.sc-pct{font-family:var(--fd);font-size:1.5rem;line-height:1;flex-shrink:0}
.sc-bw{flex:1}.sc-bar{height:8px;background:var(--mn);border-radius:5px;overflow:hidden;margin-bottom:4px}
.sc-fill{height:100%;border-radius:5px;transition:width .5s ease}
.sc-tg{display:flex;justify-content:space-between;font-size:.71rem;color:#aaa}
.sc-meta{font-size:.71rem;color:#bbb;margin-top:5px}
.sc-status{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.sc-status-pill{padding:4px 12px;border-radius:20px;font-size:.78rem;font-weight:600}
.sc-status-pill.hit{background:#D6F0E0;color:#1A7A4A}.sc-status-pill.miss{background:#FFF3CD;color:#7D5A00}
.sc-ms{padding:15px 22px 18px}
.sc-ms-lbl{font-size:.68rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:#aaa;margin-bottom:11px}
.sc-mg{display:grid;grid-template-columns:repeat(4,1fr);border:1px solid #eee;border-radius:8px;overflow:hidden}
.sc-mc{border-right:1px solid #eee;border-bottom:1px solid #eee}
.sc-mc:nth-child(4n){border-right:none}.sc-mc:nth-last-child(-n+4){border-bottom:none}
.sc-mch{padding:5px 9px;background:#fafafa;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
.sc-mn2{font-size:.66rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:#aaa}
.sc-mn2.cur{color:var(--t)}.sc-qt{font-size:.59rem;font-weight:700;padding:1px 5px;border-radius:3px}
.sc-mcb{padding:7px 9px 8px}
.sc-val{width:100%;padding:3px 7px;border:1.5px solid #e8e8e8;border-radius:5px;font-family:var(--fd);font-size:.95rem;color:var(--dt);background:var(--wh);outline:none;transition:border-color .14s;margin-bottom:4px}
.sc-val:focus{border-color:var(--t)}.sc-val.f{border-color:#ddd;background:#faffff}
.sc-val::placeholder{font-family:var(--fb);font-size:.76rem;color:#ccc}
.sc-notes{width:100%;padding:3px 7px;border:1.5px solid #e8e8e8;border-radius:5px;font-family:var(--fb);font-size:.7rem;color:var(--ch);background:var(--wh);outline:none;resize:none;min-height:38px;transition:border-color .14s;line-height:1.4}
.sc-notes:focus{border-color:var(--t)}.sc-notes.f{border-color:#ddd;background:#fffdf5}
.sc-notes::placeholder{color:#ccc}
.sc-mini{height:2px;border-radius:2px;background:#eee;overflow:hidden;margin-top:4px}
.sc-mini-f{height:100%;border-radius:2px}

.edit-meta-chip{font-size:.7rem;font-weight:600;color:var(--td);background:var(--tl);border:1px solid var(--mn);border-radius:4px;padding:2px 8px;cursor:pointer;transition:all .14s}
.edit-meta-chip:hover{background:var(--mn);border-color:var(--t)}
.week-btn{background:none;border:1.5px solid #ddd;border-radius:6px;padding:4px 10px;font-family:var(--fb);font-size:.78rem;cursor:pointer;color:var(--ch);transition:all .14s}
.week-btn:hover{border-color:var(--t);color:var(--dt)}
.inline-edit{border:none;border-bottom:2px solid var(--t);background:transparent;font-family:var(--fb);font-size:.82rem;color:var(--ch);outline:none;min-width:200px;padding:1px 2px}

/* AUTH SCREEN */
.auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80vh;gap:24px;text-align:center}
.auth-card{background:var(--wh);border-radius:16px;padding:48px 56px;box-shadow:var(--shl);max-width:440px;width:100%}
.auth-logo{font-family:var(--fd);font-size:1.8rem;color:var(--dt);margin-bottom:6px}
.auth-sub{font-size:.88rem;color:#999;margin-bottom:32px}
.btn-google{display:inline-flex;align-items:center;gap:10px;padding:12px 24px;border-radius:8px;font-family:var(--fb);font-size:.9rem;font-weight:600;cursor:pointer;border:1.5px solid #ddd;background:var(--wh);color:var(--ch);transition:all .14s}
.btn-google:hover{border-color:var(--t);background:var(--tl)}
.btn-google svg{flex-shrink:0}

/* LOADING */
.loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.85);display:flex;align-items:center;justify-content:center;z-index:1000;flex-direction:column;gap:14px}
.spinner{width:36px;height:36px;border:3px solid var(--mn);border-top-color:var(--t);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:.82rem;color:#aaa}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--dt);color:var(--wh);padding:10px 18px;border-radius:8px;font-size:.82rem;box-shadow:0 4px 20px rgba(0,0,0,.2);z-index:2000;opacity:0;transform:translateY(8px);transition:all .25s}
.toast.show{opacity:1;transform:none}
.toast.err{background:#b22222}

/* Print button */
.print-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:7px;font-family:var(--fb);font-size:.8rem;font-weight:600;cursor:pointer;border:1.5px solid var(--mn);color:var(--dt);background:var(--wh);transition:all .14s;text-decoration:none;white-space:nowrap}
.print-btn:hover{border-color:var(--t);background:var(--tl)}

@media print{
  header,.save-indicator,.week-btn,.btn,.print-btn{display:none!important}
  main{padding:0}
  .view{display:block!important}
  .view:not(.active){display:none!important}
}
</style>
</head>
<body>
<div class="app" id="app" style="display:none">
<header>
  <span style="font-family:Georgia,serif;font-size:1.15rem;font-style:italic;color:#27A8AF;letter-spacing:.01em;opacity:.95;flex-shrink:0">Maya Smart</span>
  <nav>
    <button onclick="show('plan')" id="nb-plan">Plan</button>
    <button onclick="show('map')" id="nb-map">Strategy Map</button>
    <button onclick="show('weekly')" id="nb-weekly" class="active">Weekly Review</button>
    <button onclick="show('scorecard')" id="nb-scorecard">Scorecard</button>
  </nav>
  <div class="hdr-r">
    <div class="save-indicator" id="save-indicator"></div>
    <div class="hdr-auth" id="auth-btn" onclick="handleAuth()">
      <span class="hdr-dot off" id="auth-dot"></span>
      <span id="auth-label">Sign in</span>
    </div>
    <select class="hdr-sel" onchange="selYear(this.value)" id="year-sel">
      <option>2026</option><option>2027</option>
    </select>
  </div>
</header>
<main>

<!-- PLAN VIEW -->
<div class="view" id="view-plan">
  <div class="pg-hdr">
    <div><div class="pg-title">Plan</div><div class="pg-sub">Annual goals · quarterly strategies · monthly deliverables · weekly tasks</div></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn btn-g btn-sm" onclick="openAddGoal()">+ Add Goal</button>
    </div>
  </div>
  <div id="plan-goals-container"><div style="text-align:center;padding:48px;color:#ccc;font-size:.9rem">Loading...</div></div>
</div>

<!-- STRATEGY MAP VIEW -->
<div class="view" id="view-map">
  <div class="pg-hdr">
    <div><div class="pg-title">Strategy Map</div><div class="pg-sub">Annual Goals · Quarterly Strategy · Monthly Deliverables · Weekly Tasks</div></div>
    <div style="display:flex;gap:8px;align-items:center">
      <a class="print-btn" href="#" onclick="printStrategyOverview();return false">
        <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6z"/></svg>
        Print Strategy Overview
      </a>
    </div>
  </div>
  <div class="mb" id="map-month-bar">
    <span class="mb-lbl">Viewing</span>
    <div class="qg"><span class="ql" style="background:var(--tl);color:var(--td)">Q1</span>
      <button class="mp" onclick="selM(this,'January','Q1')">January</button>
      <button class="mp hd active" onclick="selM(this,'February','Q1')">February</button>
      <button class="mp" onclick="selM(this,'March','Q1')">March</button>
    </div>
    <div class="qdiv"></div>
    <div class="qg"><span class="ql" style="background:var(--gl);color:var(--gd)">Q2</span>
      <button class="mp" onclick="selM(this,'April','Q2')">April</button>
      <button class="mp" onclick="selM(this,'May','Q2')">May</button>
      <button class="mp" onclick="selM(this,'June','Q2')">June</button>
    </div>
    <div class="qdiv"></div>
    <div class="qg"><span class="ql" style="background:var(--nl);color:var(--nd)">Q3</span>
      <button class="mp" onclick="selM(this,'July','Q3')">July</button>
      <button class="mp" onclick="selM(this,'August','Q3')">August</button>
      <button class="mp" onclick="selM(this,'September','Q3')">September</button>
    </div>
    <div class="qdiv"></div>
    <div class="qg"><span class="ql" style="background:#FFF8E7;color:#7D5A00">Q4</span>
      <button class="mp" onclick="selM(this,'October','Q4')">October</button>
      <button class="mp" onclick="selM(this,'November','Q4')">November</button>
      <button class="mp" onclick="selM(this,'December','Q4')">December</button>
    </div>
  </div>
  <div class="map-wrap">
    <table class="map-tbl">
      <thead><tr>
        <th style="width:15%">2026 Goal</th>
        <th style="width:19%" id="th-q">Q1 Strategy</th>
        <th style="width:24%" id="th-d">February Deliverables</th>
        <th>This Week's Tasks</th>
      </tr></thead>
      <tbody id="map-tbody"></tbody>
    </table>
  </div>
</div>

<!-- WEEKLY REVIEW VIEW -->
<div class="view active" id="view-weekly">
  <div class="w-bar">
    <div>
      <div style="font-size:.66rem;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,255,255,.4);margin-bottom:3px">Week of</div>
      <div class="w-week" id="w-week-title">Loading...</div>
    </div>
    <div class="w-stats">
      <div style="text-align:center"><div class="wsn" style="color:var(--t)" id="ws-total">—</div><div class="wsl">Tasks</div></div>
      <div style="text-align:center"><div class="wsn" style="color:#D6F0E0" id="ws-complete">—</div><div class="wsl">Complete</div></div>
      <div style="text-align:center"><div class="wsn" style="color:var(--go)" id="ws-inprog">—</div><div class="wsl">In Progress</div></div>
      <div style="text-align:center"><div class="wsn" style="color:rgba(255,255,255,.7)" id="ws-pct">—</div><div class="wsl">Done</div></div>
    </div>
  </div>

  <!-- Week selector -->
  <div style="display:flex;align-items:center;gap:6px;margin-bottom:12px;flex-wrap:wrap">
    <button class="week-btn" onclick="shiftWeek(-1)">← Prev</button>
    <div style="background:var(--wh);border:1.5px solid #ddd;border-radius:6px;padding:5px 16px;font-family:var(--fb);font-size:.82rem;font-weight:600;color:var(--dt)" id="week-label">Loading...</div>
    <button class="week-btn" onclick="shiftWeek(1)">Next →</button>
    <span style="font-size:.72rem;color:#aaa;margin-left:4px" id="week-note"></span>
    <div style="margin-left:auto;display:flex;gap:8px">
      <a class="print-btn" href="#" onclick="printWeeklyReview();return false">
        <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6z"/></svg>
        Print Weekly Review
      </a>
    </div>
  </div>

  <!-- Summary strip -->
  <div class="sum-strip" id="sum-strip">
    <div class="sum-lbl">This week</div>
    <div class="sum-body" id="sum-body">
      <div style="font-size:.78rem;color:#ccc">Loading...</div>
    </div>
  </div>

  <div class="w-goals" id="weekly-goals-container">
    <div style="text-align:center;padding:48px;color:#ccc;font-size:.9rem">Loading tasks...</div>
  </div>
</div>

<!-- SCORECARD VIEW -->
<div class="view" id="view-scorecard">
  <div class="pg-hdr">
    <div><div class="pg-title">2026 Scorecard</div><div class="pg-sub">Monthly progress toward your annual goals</div></div>
    <div style="display:flex;gap:8px;align-items:center">
    </div>
  </div>
  <div class="sc-grid" id="scorecard-container">
    <div style="text-align:center;padding:48px;color:#ccc;font-size:.9rem">Loading...</div>
  </div>
</div>

</main>
</div>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <main style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:32px">
    <div class="auth-card">
      <div class="auth-logo">2026 Strategy Tracker</div>
      <div class="auth-sub">Connect your Google account to sync with your strategy spreadsheet.</div>
      <button class="btn-google" onclick="signIn()">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        Continue with Google
      </button>
      <div style="margin-top:24px;font-size:.75rem;color:#ccc">Your data stays in your Google Sheets — we only read &amp; write what you authorize.</div>
    </div>
  </main>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loading" style="display:none">
  <div class="spinner"></div>
  <div class="loading-text" id="loading-text">Loading your strategy...</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════════════════
var CLIENT_ID = '1076267940073-cu6lncgl6s32v8imv8d0v3451hch4it3.apps.googleusercontent.com';
var SHEET_ID = '1ZloCLoNhaVjjr57vWJrOstS1NszShNpiyk9cL4bXgS8';
var SALES_SHEET_ID = '1Xd5Ck1-JBr2tWKtfWStaJtykrkNvXl6QTw48476nlwk';
var SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
var REDIRECT_URI = 'https://mayasmart.github.io/strategy-tracker/';

// ═══════════════════════════════════════════════════════════
// AUTH — PKCE OAuth2
// ═══════════════════════════════════════════════════════════
var accessToken = null;
var tokenExpiry = null;

function isSignedIn(){
  return accessToken && tokenExpiry && Date.now() < tokenExpiry;
}

async function signIn(){
  var params = new URLSearchParams({
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT_URI,
    response_type: 'token',
    scope: SCOPES,
    prompt: 'consent'
  });
  window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params;
}

async function handleOAuthCallback(){
  // Implicit flow returns token in URL hash fragment
  var hash = window.location.hash.substring(1);
  if(!hash) return false;
  var params = new URLSearchParams(hash);
  var token = params.get('access_token');
  var expiresIn = params.get('expires_in');
  if(!token) return false;
  showLoading('Signing in...');
  accessToken = token;
  tokenExpiry = Date.now() + (parseInt(expiresIn)||3600)*1000;
  localStorage.setItem('access_token', accessToken);
  localStorage.setItem('token_expiry', tokenExpiry);
  // Clean URL
  window.history.replaceState({}, '', window.location.pathname);
  return true;
}

async function refreshToken(){
  // Implicit flow has no refresh token — re-prompt silently
  var params = new URLSearchParams({
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT_URI,
    response_type: 'token',
    scope: SCOPES,
    prompt: 'none'
  });
  window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params;
  return false;
}

function signOut(){
  accessToken = null;
  tokenExpiry = null;
  localStorage.removeItem('access_token');
  localStorage.removeItem('token_expiry');
  localStorage.removeItem('refresh_token');
  updateAuthUI(false);
  document.getElementById('auth-screen').style.display = '';
  document.getElementById('app').style.display = 'none';
}

function handleAuth(){
  if(isSignedIn()){
    if(confirm('Sign out?')) signOut();
  } else {
    signIn();
  }
}

function updateAuthUI(loggedIn, email){
  var dot = document.getElementById('auth-dot');
  var label = document.getElementById('auth-label');
  if(loggedIn){
    dot.className = 'hdr-dot';
    label.textContent = email || 'Signed in';
  } else {
    dot.className = 'hdr-dot off';
    label.textContent = 'Sign in';
  }
}

// ═══════════════════════════════════════════════════════════
// SHEETS API
// ═══════════════════════════════════════════════════════════
async function sheetsGet(sheetId, range){
  var url = 'https://sheets.googleapis.com/v4/spreadsheets/'+sheetId+'/values/'+encodeURIComponent(range);
  var resp = await fetch(url,{headers:{'Authorization':'Bearer '+accessToken}});
  if(resp.status===401){ if(await refreshToken()) return sheetsGet(sheetId,range); throw new Error('Unauthorized'); }
  return resp.json();
}

async function sheetsUpdate(sheetId, range, values){
  var url = 'https://sheets.googleapis.com/v4/spreadsheets/'+sheetId+'/values/'+encodeURIComponent(range)+'?valueInputOption=USER_ENTERED';
  var resp = await fetch(url,{
    method:'PUT',
    headers:{'Authorization':'Bearer '+accessToken,'Content-Type':'application/json'},
    body: JSON.stringify({range,values})
  });
  if(resp.status===401){ if(await refreshToken()) return sheetsUpdate(sheetId,range,values); throw new Error('Unauthorized'); }
  return resp.json();
}

async function sheetsBatchGet(sheetId, ranges){
  var q = ranges.map(r=>'ranges='+encodeURIComponent(r)).join('&');
  var url = 'https://sheets.googleapis.com/v4/spreadsheets/'+sheetId+'/values:batchGet?'+q;
  var resp = await fetch(url,{headers:{'Authorization':'Bearer '+accessToken}});
  if(resp.status===401){ if(await refreshToken()) return sheetsBatchGet(sheetId,ranges); throw new Error('Unauthorized'); }
  return resp.json();
}

// ═══════════════════════════════════════════════════════════
// DATA MODEL (in-memory, synced with Sheets)
// ═══════════════════════════════════════════════════════════

// SHEET LAYOUT ASSUMPTIONS:
// "Weekly Review" tab:
//   Row 1: Headers: Week | Task ID | Goal# | Deliverable | Task | Status | RecurringCount | RecurringTarget | Notes
//   Rows 2+: Data rows — one per task per week
//   Week format: "2026-W08" (ISO week)
//
// "Scorecard" tab:
//   Row 1: Headers: Goal# | Jan | Feb | Mar | ... | Dec | Jan Notes | Feb Notes...
//
// "Call Log" tab (Sales tracker):
//   Columns: Date | Type (Requested/Held/Closed) | Count | Notes

var MD = [
  {n:1,year:2026,t:'10 or more $10,000+ Clients',c:'#27A8AF',l:'#E6F6F7',d:'#005A5E',target:10,type:'cumulative',label:'clients',
    s:'Develop scalable programs and a sales system to land new clients',
    delivs:[
      {c:'#27A8AF',t:'Pursue sales',standing:true,
        tasks:[{id:'T1',t:'Requested calls',s:'ip',count:3,target:2,week:'2026-W09',type:'count'},{id:'T2',t:'Held calls',s:'ns',count:0,target:1,week:'2026-W09',type:'count'},{id:'T3',t:'Closed sales',s:'ns',count:null,target:null,week:'2026-W09',type:'count'}]},
      {c:'#27A8AF',t:'Deliver FLL curriculum scripts to WI CAN',
        tasks:[{id:'T4',t:'Submit FLL Module 1 Scripts',s:'cp',week:'2026-W09'},{id:'T5',t:'Revise FLL 1.3',s:'ip',week:'2026-W09'},{id:'T6',t:'Draft FLL 1.4',s:'ns',week:'2026-W09'},{id:'T7',t:'Draft FLL 1.5',s:'ns',week:'2026-W09'}]},
      {c:'#1D7A80',t:'Complete LETRS Module 3',
        tasks:[{id:'T8',t:'Watch 3.6 videos and take quiz',s:'cp',week:'2026-W09'},{id:'T9',t:'Watch 3.7 videos and take quiz',s:'ns',week:'2026-W09'},{id:'T10',t:'Watch 3.8 videos and take quiz',s:'ns',week:'2026-W09'}]},
      {c:'#0F4F54',t:'Launch Power Content ads',
        tasks:[{id:'T11',t:'Watch tutorial on setting up ads',s:'ns',week:'2026-W09'},{id:'T12',t:'Set up ads and notify Maggie and Michael',s:'ns',week:'2026-W09'}]}
    ]},
  {n:2,year:2026,t:'20% Profit Margin',c:'#D9BC52',l:'#FDF7E3',d:'#A07E00',target:20,type:'threshold',label:'%',
    s:'Set up a system to monitor and reduce business spending',
    delivs:[
      {c:'#D9BC52',t:'Audit and cancel unnecessary subscriptions',
        tasks:[{id:'T13',t:'Cancel unnecessary subscriptions',s:'ip',week:'2026-W09'},{id:'T14',t:'Review Monarch data',s:'ns',week:'2026-W09'}]},
      {c:'#A07E00',t:'Review and categorize February spending',
        tasks:[{id:'T15',t:'Review receipts in Gmail',s:'ns',week:'2026-W09'}]}
    ]},
  {n:3,year:2026,t:'Sell 10,000 copies of Reading for Our Lives',c:'#39436e',l:'#ECEEF5',d:'#1E2545',target:20000,type:'cumulative',label:'copies',
    s:'Sell 2,500 copies between January 1 and March 31, 2026',
    delivs:[
      {c:'#39436e',t:'Expand book sales channels',
        tasks:[{id:'T16',t:'Deliver books and table tents to Harmonic Harvest',s:'ns',week:'2026-W09'},{id:'T17',t:'Schedule meeting with Michael re: virtual book club',s:'ns',week:'2026-W09'}]}
    ]}
];

var SC = [
  {gn:1,color:'#27A8AF',gl:'#E6F6F7',type:'cumulative',label:'clients',target:10,
    months:{Jan:1,Feb:2},notes:{Feb:'Added Maya\'s Literacy Lab. WI CAN $12k, MLL $15k'}},
  {gn:2,color:'#D9BC52',gl:'#FDF7E3',type:'threshold',label:'%',target:20,months:{},notes:{}},
  {gn:3,color:'#39436e',gl:'#ECEEF5',type:'cumulative',label:'copies',target:20000,
    months:{Jan:10843,Feb:11093},notes:{Feb:'250 new copies. Harmonic Harvest order placed.'}}
];

// Week state
var CURRENT_WEEK_ISO = getISOWeek(new Date());
var viewingWeek = CURRENT_WEEK_ISO;
var weekData = {}; // { 'YYYY-Wxx': { taskId: {status, count, notes} } }
weekData[CURRENT_WEEK_ISO] = {}; // ensure current week always has an entry

// ═══════════════════════════════════════════════════════════
// DATE / WEEK UTILITIES
// ═══════════════════════════════════════════════════════════
function getISOWeek(date){
  var d = new Date(date);
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() + 3 - (d.getDay()+6)%7);
  var week1 = new Date(d.getFullYear(),0,4);
  var w = 1 + Math.round(((d-week1)/86400000 - 3 + (week1.getDay()+6)%7)/7);
  return d.getFullYear() + '-W' + String(w).padStart(2,'0');
}

function isoWeekToMonday(isoWeek){
  var [year, w] = isoWeek.split('-W').map(Number);
  var jan4 = new Date(year, 0, 4);
  var day1 = jan4.getDay() || 7;
  var monday = new Date(jan4);
  monday.setDate(jan4.getDate() + (w-1)*7 - (day1-1));
  return monday;
}

function formatWeekLabel(isoWeek){
  var monday = isoWeekToMonday(isoWeek);
  var opts = {month:'short', day:'numeric', year:'numeric'};
  return 'Week of ' + monday.toLocaleDateString('en-US', opts);
}

function weekBadgeLabel(isoWeek){
  if(!isoWeek) return 'Unscheduled';
  var monday = isoWeekToMonday(isoWeek);
  return monday.toLocaleDateString('en-US', {month:'short', day:'numeric'});
}

function isWeekPast(isoWeek){
  if(!isoWeek) return false;
  return isoWeek < CURRENT_WEEK_ISO;
}

function shiftWeekISO(isoWeek, delta){
  var monday = isoWeekToMonday(isoWeek);
  monday.setDate(monday.getDate() + delta*7);
  return getISOWeek(monday);
}

function getWeekNote(isoWeek){
  if(isoWeek === CURRENT_WEEK_ISO) return '← current week';
  var cm = isoWeekToMonday(CURRENT_WEEK_ISO);
  var vm = isoWeekToMonday(isoWeek);
  return vm < cm ? 'past week' : 'future week';
}

// ═══════════════════════════════════════════════════════════
// SHEETS SYNC
// ═══════════════════════════════════════════════════════════
var saveTimer = null;
var pendingChanges = {}; // {range: values}
var isSaving = false;

function queueSave(range, values){
  if(!isSignedIn()) return;
  pendingChanges[range] = values;
  showSaveIndicator('pending');
  clearTimeout(saveTimer);
  // 150ms debounce — batches rapid keystrokes but feels instant
  saveTimer = setTimeout(flushSave, 150);
}

function showSaveIndicator(state){
  var el = document.getElementById('save-indicator');
  if(!el) return;
  if(state === 'pending'){ el.textContent = 'Saving…'; el.className = 'save-indicator saving'; }
  else if(state === 'saved'){ el.textContent = 'Saved ✓'; el.className = 'save-indicator saved'; setTimeout(function(){ el.textContent=''; el.className='save-indicator'; }, 2000); }
  else if(state === 'error'){ el.textContent = 'Save failed'; el.className = 'save-indicator error'; }
}

async function flushSave(){
  if(!isSignedIn() || Object.keys(pendingChanges).length === 0) return;
  if(isSaving){
    // Already saving — reschedule to run after current save finishes
    saveTimer = setTimeout(flushSave, 200);
    return;
  }
  isSaving = true;
  var toSave = Object.assign({}, pendingChanges);
  pendingChanges = {};
  try{
    for(var range in toSave){
      await sheetsUpdate(SHEET_ID, range, toSave[range]);
    }
    showSaveIndicator('saved');
  }catch(e){
    // Put failed changes back so they retry
    Object.assign(pendingChanges, toSave);
    showSaveIndicator('error');
    showToast('Could not save to Google Sheets', true);
  }
  isSaving = false;
  // If more changes queued while we were saving, flush them now
  if(Object.keys(pendingChanges).length > 0){
    saveTimer = setTimeout(flushSave, 150);
  }
}

// Load weekly task statuses for a given week from Sheets
async function loadWeeklyData(isoWeek){
  if(!isSignedIn()) return;
  try{
    var data = await sheetsGet(SHEET_ID, 'Weekly Review!A:I');
    var rows = data.values || [];
    // Parse rows: [Week, TaskID, Goal#, Deliverable, Task, Status, RecurringCount, RecurringTarget, Notes]
    // Load all weeks at once so navigation to past/future weeks works
    rows.forEach(function(row, i){
      if(i===0) return; // skip header
      var wk = row[0]; var tid = row[1];
      if(!wk || !tid) return;
      if(!weekData[wk]) weekData[wk] = {};
      weekData[wk][tid] = {
        status: row[5] || 'ns',
        count: row[6] !== undefined && row[6] !== '' ? parseInt(row[6]) || null : null,
        notes: row[8] || ''
      };
    });
  }catch(e){ console.warn('Could not load weekly data', e); }
}

// Load sales call data from sales tracker
async function loadSalesData(){
  if(!isSignedIn()) return;
  try{
    var monday = isoWeekToMonday(viewingWeek);
    var sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
    var data = await sheetsGet(SALES_SHEET_ID, 'Call Log!A:D');
    var rows = data.values || [];
    var requested=0, held=0, closed=0;
    rows.forEach(function(row,i){
      if(i===0) return;
      var d = new Date(row[0]);
      if(d >= monday && d <= sunday){
        var type = (row[1]||'').toLowerCase();
        var count = parseInt(row[2])||1;
        if(type.includes('request')) requested += count;
        else if(type.includes('held') || type.includes('complete')) held += count;
        else if(type.includes('clos') || type.includes('sale')) closed += count;
      }
    });
    // Inject into MD goal 1 pursue sales
    var g1 = MD[0];
    var ps = g1.delivs[0];
    if(requested > 0) ps.tasks[0].count = requested;
    if(held > 0) ps.tasks[1].count = held;
    if(closed > 0) ps.tasks[2].count = closed;
  }catch(e){ console.warn('Could not load sales data', e); }
}

async function loadScorecardData(){
  if(!isSignedIn()) return;
  try{
    var data = await sheetsGet(SHEET_ID, 'Scorecard!A:Z');
    var rows = data.values || [];
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    rows.forEach(function(row, ri){
      if(ri === 0) return; // header
      var gn = parseInt(row[0]);
      var sc = SC.find(s => s.gn === gn);
      if(!sc) return;
      sc.months = {};
      sc.notes = {};
      months.forEach(function(m, mi){
        var val = row[1+mi];
        if(val !== undefined && val !== '' && val !== null){
          var parsed = parseFloat(String(val).replace(/[^0-9.]/g,''));
          if(!isNaN(parsed)) sc.months[m] = parsed;
        }
        var note = row[13+mi];
        if(note) sc.notes[m] = note;
      });
    });
  }catch(e){ console.warn('Could not load scorecard data', e); }
}

// Save all weekly task statuses as a full snapshot for the viewing week
function saveWeeklyData(){
  if(!isSignedIn()) return;
  // Collect all tasks across all weeks that have weekData entries
  var rows = [['Week','TaskID','GoalN','Deliverable','Task','Status','RecurringCount','RecurringTarget','Notes']];
  // Write all known week entries
  Object.keys(weekData).forEach(function(wk){
    var wd = weekData[wk];
    Object.keys(wd).forEach(function(taskId){
      var entry = wd[taskId];
      // Find task info from MD
      var taskObj = null, delivTitle = '', goalN = '';
      MD.forEach(function(g){ g.delivs.forEach(function(d){ d.tasks.forEach(function(t){
        if(t.id === taskId){ taskObj = t; delivTitle = d.t; goalN = g.n; }
      }); }); });
      if(!taskObj) return;
      rows.push([wk, taskId, goalN, delivTitle, taskObj.t, entry.status||'ns', entry.count||'', '', entry.notes||'']);
    });
  });
  queueSave('Weekly Review!A1:I'+rows.length, rows);
}

function saveTaskStatus(taskId, goalN, delivTitle, taskTitle, status, count, notes){
  saveWeeklyData();
}

// Save scorecard value
function saveScorecardVal(goalN, month, value, notes){
  if(!isSignedIn()) return;
  var sc = SC.find(s => s.gn === goalN);
  if(!sc) return;
  var parsed = value === '' || value === null || value === undefined ? undefined : parseFloat(value);
  if(parsed !== undefined && !isNaN(parsed)){
    sc.months[month] = parsed;
  } else {
    delete sc.months[month];
  }
  if(notes !== undefined) sc.notes[month] = notes;
  // Build full row for this goal
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var vals = [goalN].concat(months.map(m => sc.months[m]!==undefined ? sc.months[m] : '')).concat(months.map(m => sc.notes[m]||''));
  var rowNum = goalN + 1;
  queueSave('Scorecard!A'+rowNum+':Z'+rowNum, [vals]);
}

// ═══════════════════════════════════════════════════════════
// PLAN SAVE / LOAD
// ═══════════════════════════════════════════════════════════
// Sheet: Plan tab
// Columns: GoalN | GoalYear | GoalTitle | GoalColor | GoalLight | GoalDark |
//          GoalTarget | GoalType | GoalLabel | GoalStrategy | GoalQuarters(JSON) |
//          DelivTitle | DelivColor | DelivStanding |
//          TaskID | TaskTitle | TaskStatus | TaskCount | TaskTarget

function savePlan(){
  if(!isSignedIn()) return;
  var rows = [['GoalN','GoalYear','GoalTitle','GoalColor','GoalLight','GoalDark','GoalTarget','GoalType','GoalLabel','GoalStrategy','GoalQuarters','DelivTitle','DelivColor','DelivStanding','TaskID','TaskTitle','TaskStatus','TaskCount','TaskTarget','TaskWeek']];
  MD.forEach(function(g){
    if(!g.delivs || g.delivs.length === 0){
      // Goal with no deliverables — still write one row
      rows.push([g.n, g.year||2026, g.t, g.c, g.l, g.d, g.target, g.type, g.label, g.s, JSON.stringify(g.quarters||{}), '', '', '', '', '', '', '', '', '']);
      return;
    }
    g.delivs.forEach(function(d){
      if(!d.tasks || d.tasks.length === 0){
        rows.push([g.n, g.year||2026, g.t, g.c, g.l, g.d, g.target, g.type, g.label, g.s, JSON.stringify(g.quarters||{}), d.t, d.c, d.standing?'1':'', '', '', '', '', '', '']);
        return;
      }
      d.tasks.forEach(function(t){
        rows.push([g.n, g.year||2026, g.t, g.c, g.l, g.d, g.target, g.type, g.label, g.s, JSON.stringify(g.quarters||{}), d.t, d.c, d.standing?'1':'', t.id, t.t, t.s||'ns', t.count!==null&&t.count!==undefined?t.count:'', t.target!==null&&t.target!==undefined?t.target:'', t.week||CURRENT_WEEK_ISO]);
      });
    });
  });
  // Write entire Plan sheet — clear then rewrite
  queueSave('Plan!A1:T'+rows.length, rows);
}

async function loadPlanData(){
  if(!isSignedIn()) return;
  try{
    var data = await sheetsGet(SHEET_ID, 'Plan!A:T');
    var rows = data.values || [];
    if(rows.length < 2) return; // no data yet
    var newMD = [];
    rows.forEach(function(row, ri){
      if(ri === 0) return; // header
      var gn = parseInt(row[0]); if(isNaN(gn)) return;
      var g = newMD.find(function(x){ return x.n===gn; });
      if(!g){
        g = {
          n: gn,
          year: parseInt(row[1])||2026,
          t: row[2]||'',
          c: row[3]||'#27A8AF',
          l: row[4]||'#E6F6F7',
          d: row[5]||'#005A5E',
          target: parseFloat(row[6])||0,
          type: row[7]||'cumulative',
          label: row[8]||'',
          s: row[9]||'',
          quarters: {},
          delivs: []
        };
        try{ g.quarters = JSON.parse(row[10]||'{}'); }catch(e){}
        newMD.push(g);
      }
      var delivTitle = row[11]||'';
      if(!delivTitle) return;
      var delivColor = row[12]||g.c;
      var isStanding = row[13]==='1';
      var d = g.delivs.find(function(x){ return x.t===delivTitle; });
      if(!d){
        d = { t: delivTitle, c: delivColor, standing: isStanding||undefined, tasks: [] };
        if(!isStanding) delete d.standing;
        g.delivs.push(d);
      }
      var taskId = row[14]||'';
      if(!taskId) return;
      var tcount = row[17]!==''&&row[17]!==undefined ? parseInt(row[17])||0 : null;
      var ttarget = row[18]!==''&&row[18]!==undefined ? parseInt(row[18]) : null;
      d.tasks.push({
        id: taskId,
        t: row[15]||'',
        s: row[16]||'ns',
        count: tcount,
        target: ttarget,
        week: row[19]||CURRENT_WEEK_ISO
      });
    });
    if(newMD.length > 0) MD = newMD;
  }catch(e){ console.warn('Could not load plan data', e); }
}


function renderWeeklyReview(){
  // Update header
  var monday = isoWeekToMonday(viewingWeek);
  var opts = {month:'long', day:'numeric', year:'numeric'};
  document.getElementById('w-week-title').textContent = monday.toLocaleDateString('en-US', opts);
  document.getElementById('week-label').textContent = formatWeekLabel(viewingWeek);
  document.getElementById('week-note').textContent = getWeekNote(viewingWeek);

  // Count stats + summary strip
  updateSummaryStrip();

  // Goal cards
  var container = document.getElementById('weekly-goals-container');
  var isCurrent = viewingWeek === CURRENT_WEEK_ISO;
  container.innerHTML = MD.map(function(g){
    var sc = SC.find(s=>s.gn===g.n);
    var progressHtml = '';
    if(sc && sc.type==='cumulative'){
      var latest = latestMonthValue(sc);
      var pctG = sc.target>0 ? Math.round(latest/sc.target*100) : 0;
      progressHtml = '<div class="wpw"><span class="wpp">'+pctG+'%</span><div class="wpb"><div class="wpf" style="width:'+Math.min(pctG,100)+'%"></div></div></div>';
    } else if(sc && sc.type==='threshold'){
      var latestT = latestMonthValue(sc);
      var metT = latestT > 0 && latestT >= sc.target;
      progressHtml = '<div class="wpw"><span class="wpp" style="background:rgba(255,255,255,.15);border-radius:10px;padding:2px 8px;font-size:.7rem">'+(metT ? '✓ On track' : '↗ Below target')+'</span></div>';
    } else {
      progressHtml = '<div class="wpw"><span class="wpp" style="background:rgba(255,255,255,.15);border-radius:10px;padding:2px 8px;font-size:.7rem">—</span></div>';
    }

    var delivsHtml = g.delivs.map(function(d){
      if(d.standing){
        return renderStandingCard(d, g, isCurrent);
      }
      var weekTasks = d.tasks.filter(function(t){ return (t.week||CURRENT_WEEK_ISO) === viewingWeek; });
      if(weekTasks.length === 0) return '';
      var tasksHtml = weekTasks.map(function(t){
        var ws = getWeekStatus(t.id);
        var ck = ws==='cp' ? ' cp' : ws==='ip' ? ' ip' : '';
        var chk = ws==='cp' ? '<svg width="10" height="8" viewBox="0 0 10 8" fill="none"><path d="M1 4L3.5 6.5L9 1" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>' : '';
        return '<div class="wtr">'
          +'<div class="wck'+ck+'" onclick="toggleTask(this,\''+g.n+'\',\''+d.t.replace(/'/g,"\\'")+'\',\''+t.id+'\')">'+chk+'</div>'
          +'<div class="wtt">'+t.t+'</div>'
          +'<select class="sel '+ws+'" onchange="cSel(this,\''+g.n+'\',\''+d.t.replace(/'/g,"\\'")+'\',\''+t.id+'\')">'          +'<option'+(ws==='ns'?' selected':'')+'>Not Started</option>'          +'<option'+(ws==='ip'?' selected':'')+'>In Progress</option>'          +'<option'+(ws==='cp'?' selected':'')+'>Complete</option>'          +'<option'+(ws==='oh'?' selected':'')+'>On Hold</option>'          +'</select></div>';
      }).join('');
      return '<div class="wdg"><div class="wdh" style="border-left-color:'+d.c+'">'
        +'<div class="dot-lg" style="background:'+d.c+'"></div><div class="wdt">'+d.t+'</div></div>'
        +'<div class="wtl">'+tasksHtml+'</div></div>';
    }).join('');
    if(!delivsHtml.trim()) return '';

    return '<div class="wgc">'
      +'<div class="wgb" style="background:'+g.c+'">'
      +'<div style="width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.28);flex-shrink:0"></div>'
      +'<div class="wgt">Goal '+g.n+' · '+g.t+'</div>'+progressHtml+'</div>'
      +'<div class="str-row" style="border-left-color:'+g.c+'">'
      +'<span class="str-qb" style="background:'+g.l+';color:'+g.d+'">Q1</span>'
      +'<span class="str-obj">'+g.s+'</span></div>'
      +delivsHtml+'</div>';
  }).join('');
}

function renderStandingCard(d, g, isCurrent){
  function recRow(t){
    var taskType = t.type || ((t.target !== null && t.target !== undefined) ? "count" : "check");
    if(taskType === "count"){
      var tgt = (t.target !== null && t.target !== undefined) ? t.target : null;
      var wc = getWeekCount(t.id);
      var v = (wc !== null && wc !== undefined) ? wc : 0;
      var hasTgt = tgt !== null;
      var cls = hasTgt ? (v>=tgt ? 'over' : (v>0 ? 'under' : '')) : '';
      var status = hasTgt ? (v>=tgt ? '<span class="rec-status over">\u2713 On target</span>' : (v>0 ? '<span class="rec-status under">\u2197 Below</span>' : '<span class="rec-status none">\u2014</span>')) : '';
      return '<div class="wtr" style="padding-left:28px">'
        +'<div class="wck"></div><div class="wtt">'+t.t+'</div>'
        +'<div class="rec-wrap">'
        +'<input class="rec-inp'+(cls?' '+cls:'')+'" type="number" min="0" value="'+(v>0?v:'')+'" placeholder="\u2014"'
        +' oninput="updRecurring(this,\''+t.id+'\','+(hasTgt?tgt:'null')+','+g.n+')">' 
        +(hasTgt ? '<span class="rec-target">/ '+tgt+' target</span>' : '<span class="rec-target">this week</span>')
        +(hasTgt ? status : '')
        +'</div></div>';
    }
    var ws = getWeekStatus(t.id);
    var ck = ws==='cp' ? ' cp' : ws==='ip' ? ' ip' : '';
    var chk = ws==='cp' ? '<svg width="10" height="8" viewBox="0 0 10 8" fill="none"><path d="M1 4L3.5 6.5L9 1" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>' : '';
    return '<div class="wtr" style="padding-left:28px">'
      +'<div class="wck'+ck+'" onclick="toggleTask(this,\''+g.n+'\',\''+d.t.replace(/'/g,"\\'")+'\',\''+t.id+'\')">'+ chk +'</div>'
      +'<div class="wtt">'+t.t+'</div>'
      +'<select class="sel '+ws+'" onchange="cSel(this,\''+g.n+'\',\''+d.t.replace(/'/g,"\\'")+'\',\''+t.id+'\')">'
      +'<option'+(ws==='ns'?' selected':'')+'>Not Started</option>'
      +'<option'+(ws==='ip'?' selected':'')+'>In Progress</option>'
      +'<option'+(ws==='cp'?' selected':'')+'>Complete</option>'
      +'<option'+(ws==='oh'?' selected':'')+'>On Hold</option>'
      +'</select></div>';
  }

  return '<div style="margin:0;border-bottom:1px solid var(--gr)">'
    +'<div style="padding:8px 20px 0;background:#fafafa;border-left:4px solid '+g.c+'">'
    +'<div style="display:flex;align-items:center;gap:7px;padding-bottom:7px;border-bottom:1px solid #f0f0f0">'
    +'<div style="width:11px;height:11px;border-radius:50%;background:'+g.c+';flex-shrink:0"></div>'
    +'<span style="font-size:.8rem;font-weight:600;color:var(--dt)">'+d.t+'</span>'
    +'<span style="font-size:.73rem;color:#aaa;font-style:italic">every week, all year</span>'
    +'<span style="margin-left:auto;font-size:.64rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--td);background:var(--mn);padding:2px 8px;border-radius:3px;flex-shrink:0">Standing</span>'
    +'</div></div>'
    +'<div style="background:var(--wh);padding:4px 0 6px">'
    +d.tasks.map(recRow).join('')
    +'</div></div>';
}
// ═══════════════════════════════════════════════════════════
// RENDER — PLAN
// ═══════════════════════════════════════════════════════════
function renderPlan(){
  var container = document.getElementById('plan-goals-container');
  // Group goals by year
  var years = {};
  MD.forEach(function(g){
    var yr = g.year || 2026;
    if(!years[yr]) years[yr] = [];
    years[yr].push(g);
  });
  var html = '';
  Object.keys(years).sort().forEach(function(yr){
    html += '<div style="margin-bottom:10px;margin-top:8px">'
      +'<div style="font-family:var(--fd);font-size:.7rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#aaa;padding:6px 2px;border-bottom:1px solid #eee;margin-bottom:14px">'+yr+' Goals</div>'
      +'<div class="plan-goals">';
    html += years[yr].map(function(g){
    var delivsHtml = g.delivs.map(function(d){
      var isStanding = d.standing;
      var tasksHtml = '';
      if(isStanding){
        tasksHtml = d.tasks.map(function(t){
          var hasTgt = t.target !== null && t.target !== undefined;
          return '<div class="tr-p" style="padding-left:36px"><div class="tt-p">'+t.t+'</div>'
            +'<div style="display:flex;align-items:center;gap:5px;flex-shrink:0">'
            +'<input type="number" min="0" placeholder="—" value="'+(t.count||'')+'" style="width:42px;text-align:center;padding:3px 5px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fd);font-size:.95rem;color:var(--dt);outline:none">'
            +'<span style="font-size:.72rem;color:#aaa">'+(hasTgt ? '/ '+t.target+' target' : 'tracked')+'</span>'
            +'</div><button class="btn-ic" onclick="openEditTask('+g.n+',\''+d.t.replace(/'/g,"\\'")+'\',\''+t.id+'\')">✎</button></div>';
        }).join('');
      } else {
        tasksHtml = d.tasks.map(function(t){
          var isPast = isWeekPast(t.week);
          var badgeCls = isPast ? 'wk-badge past' : 'wk-badge';
          return '<div class="tr-p"><div class="dot-sm" style="background:'+d.c+'"></div>'
            +'<div class="tt-p">'+t.t+'</div>'
            +'<span class="'+badgeCls+'" onclick="openScheduleTask(\''+t.id+'\')">' + weekBadgeLabel(t.week) + '</span>'
            +'<button class="btn-ic" onclick="openEditTask('+g.n+',\''+d.t.replace(/'/g,"\\'")+'\',\''+t.id+'\')">✎</button></div>';
        }).join('');
        tasksHtml += '<div class="add-r"><button class="btn btn-g btn-sm" onclick="openAddTask('+g.n+',\''+d.t.replace(/'/g,"\\'")+'\')">+ Task</button></div>';
      }
      return '<div class="db"><div class="dh" style="border-left-color:'+d.c+'">'
        +'<div class="dot-lg" style="background:'+d.c+'"></div>'
        +'<div class="dt2">'+d.t+'</div>'
        +(isStanding ? '<span style="font-size:.65rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--td);background:var(--mn);padding:2px 7px;border-radius:3px">Standing</span>' : '')
        +'<button class="btn-ic dh-edit" data-gn="'+g.n+'" data-dt="'+d.t.replace(/"/g,'&quot;')+'" style="margin-left:auto">✎</button>'
        +'</div><div class="tl-p">'+tasksHtml+'</div></div>';
    }).join('');

    return '<div class="gc" style="border-top:4px solid '+g.c+'">'
      +'<div class="gc-hdr"><div>'
      +'<div class="gc-num">'+(g.year||2026)+' Goal '+g.n+'</div>'
      +'<div class="gc-title">'+g.t+'</div>'
      +'<div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">'
      +'<span class="edit-meta-chip" onclick="editMeta('+g.n+')">Target: '+g.target+' '+g.label+'</span>'
      +'<span class="edit-meta-chip" onclick="editMeta('+g.n+')">Type: '+g.type+'</span>'
      +'</div></div>'
      +'<div style="display:flex;gap:5px;flex-shrink:0"><button class="btn btn-g btn-sm" onclick="openEditGoal('+g.n+')">Edit</button><button class="btn btn-g btn-sm" onclick="openAddStrategy('+g.n+')">+ Quarterly Strategy</button></div></div>'
      +'<div class="sb"><div class="sh">'
      +'<div style="display:flex;align-items:center;flex:1;min-width:0;gap:9px">'
      +'<span class="qb" style="background:'+g.l+';color:'+g.d+'">Q1</span>'
      +'<span class="so" id="s'+g.n+'-obj" onclick="editStrategy(\'s'+g.n+'-obj\')">'+g.s+'</span></div>'
      +'<button class="btn btn-ic" onclick="editStrategy(\'s'+g.n+'-obj\')">✎</button>'
      +'<button class="btn btn-g btn-sm" style="flex-shrink:0" onclick="openAddDeliverable('+g.n+')">+ Monthly Deliverable</button>'
      +'<button class="btn btn-g btn-sm" style="flex-shrink:0" onclick="openAddStandingDeliverable('+g.n+')">+ Standing Deliverable</button></div>'
      +delivsHtml+'</div></div>';
  }).join('');
    html += '</div></div>';
  });
  container.innerHTML = html;
}

// ═══════════════════════════════════════════════════════════
// RENDER — STRATEGY MAP
// ═══════════════════════════════════════════════════════════
var SL={ns:'Not Started',ip:'In Progress',cp:'Complete',oh:'On Hold'};
function renderMap(month,q){
  var tbody=document.getElementById('map-tbody');
  var isFeb=month==='February';
  tbody.innerHTML=MD.map(function(g){
    var dc=isFeb
      ? g.delivs.map(function(d){return '<div class="map-di"><div class="dot-lg" style="background:'+d.c+';flex-shrink:0"></div><div class="map-dt2">'+d.t+(d.standing?' <span style="font-size:.6rem;font-weight:700;color:var(--td);background:var(--mn);padding:1px 5px;border-radius:3px">Standing</span>':'')+'</div></div>';}).join('')
      : '<div class="no-data">No '+month+' deliverables yet</div>';
    var tc=isFeb
      ? g.delivs.map(function(d,i){
          var rows=d.tasks.map(function(t){
            if(d.standing){
              var taskType = t.type || ((t.target !== null && t.target !== undefined) ? 'count' : 'check');
              if(taskType === 'count'){
                var wc = getWeekCount(t.id);
                var hasTgt = t.target !== null && t.target !== undefined;
                var chipStyle, chipText;
                if(!hasTgt){ chipStyle='background:#eee;color:#888'; chipText=(wc>0?wc:'—')+' this week'; }
                else if(!wc||wc===0){chipStyle='background:#eee;color:#888';chipText='— / '+t.target;}
                else if(wc>=t.target){chipStyle='background:#D6F0E0;color:#1A7A4A';chipText=wc+' / '+t.target+' ✓';}
                else{chipStyle='background:#FFF3CD;color:#7D5A00';chipText=wc+' / '+t.target+' ↗';}
                return '<div class="map-ti"><div class="dot-sm" style="background:'+d.c+';flex-shrink:0"></div><span class="map-tt">'+t.t+'</span><span style="font-size:.7rem;font-weight:600;padding:2px 8px;border-radius:10px;flex-shrink:0;'+chipStyle+'">'+chipText+'</span></div>';
              }
              // check-type standing task — show status chip
              var ws2=getWeekStatus(t.id);
              var cm2={ns:'background:#e8e8e8;color:#555',ip:'background:#FFF3CD;color:#7D5A00',cp:'background:#D6F0E0;color:#1A7A4A',oh:'background:#FFE4E4;color:#b22222'};
              var cl2={ns:'Not Started',ip:'In Progress',cp:'Complete',oh:'On Hold'};
              return '<div class="map-ti"><div class="dot-sm" style="background:'+d.c+';flex-shrink:0"></div><span class="map-tt">'+t.t+'</span><span style="font-size:.7rem;font-weight:600;padding:2px 8px;border-radius:10px;flex-shrink:0;'+(cm2[ws2]||cm2.ns)+'">'+(cl2[ws2]||'Not Started')+'</span></div>';
            }
            var cm={ns:'background:#e8e8e8;color:#555',ip:'background:#FFF3CD;color:#7D5A00',cp:'background:#D6F0E0;color:#1A7A4A',oh:'background:#FFE4E4;color:#b22222'};
            var cl={ns:'Not Started',ip:'In Progress',cp:'Complete',oh:'On Hold'};
            var ws=getWeekStatus(t.id);
            return '<div class="map-ti"><div class="dot-sm" style="background:'+d.c+';flex-shrink:0"></div><span class="map-tt">'+t.t+'</span><span style="font-size:.7rem;font-weight:600;padding:2px 8px;border-radius:10px;flex-shrink:0;'+(cm[ws]||cm.ns)+'">'+(cl[ws]||'Not Started')+'</span></div>';
          }).join('');
          var div=i<g.delivs.length-1?'<div class="map-tdiv"></div>':'';
          return rows+div;
        }).join('')
      : '<div class="no-data">No '+month+' tasks yet</div>';
    return '<tr>'
      +'<td style="background:'+g.l+';border-left:5px solid '+g.c+';vertical-align:middle"><div class="map-gn" style="color:'+g.c+'">2026 GOAL '+g.n+'</div><div class="map-gt">'+g.t+'</div></td>'
      +'<td style="background:'+g.d+';vertical-align:middle"><div class="map-qo">'+g.s+'</div></td>'
      +'<td style="background:'+g.l+';border-left:4px solid '+g.c+';vertical-align:middle">'+dc+'</td>'
      +'<td style="vertical-align:top">'+tc+'</td>'
      +'</tr>';
  }).join('');
}

// ═══════════════════════════════════════════════════════════
// RENDER — SCORECARD
// ═══════════════════════════════════════════════════════════
var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

// Returns the value from the most recently entered month (in calendar order)
// Skips months that are undefined, empty string, or null (but NOT legitimate zero values
// — zero is valid for e.g. profit margin; we only skip truly absent entries)
function latestMonthValue(sc){
  for(var i = MONTHS.length-1; i >= 0; i--){
    var v = sc.months[MONTHS[i]];
    if(v !== undefined && v !== '' && v !== null) return Number(v);
  }
  return 0;
}
var Q_COLORS = {Q1:{bg:'var(--tl)',c:'var(--td)'},Q2:{bg:'var(--gl)',c:'var(--gd)'},Q3:{bg:'var(--nl)',c:'var(--nd)'},Q4:{bg:'#FFF8E7',c:'#7D5A00'}};
function mQ(i){return i<3?'Q1':i<6?'Q2':i<9?'Q3':'Q4';}
var CUR_MONTH = new Date().toLocaleString('en-US',{month:'short'}); // e.g. "Feb"

function renderScorecard(){
  var container = document.getElementById('scorecard-container');
  container.innerHTML = SC.map(function(sc){
    var g = MD.find(g=>g.n===sc.gn);
    if(!g) return '';

    // Compute progress
    var latest = latestMonthValue(sc);
    var progressHtml = '';
    if(sc.type==='cumulative'){
      var pct = sc.target>0 ? Math.min(100,Math.round(latest/sc.target*100)) : 0;
      progressHtml = '<div class="sc-pr"><div class="sc-pct" style="color:'+sc.color+'">'+pct+'%</div>'
        +'<div class="sc-bw"><div class="sc-bar"><div class="sc-fill" style="width:'+pct+'%;background:'+sc.color+'"></div></div>'
        +'<div class="sc-tg"><span style="color:'+sc.color+';font-weight:600">'+latest.toLocaleString()+' '+sc.label+'</span><span>target: '+sc.target.toLocaleString()+'</span></div></div></div>';
    } else {
      var met = latest >= sc.target;
      progressHtml = '<div class="sc-status"><span class="sc-status-pill '+(met?'hit':'miss')+'">'+(met?'✓ On target':'↗ Below target')+'</span>'
        +'<span style="font-size:.75rem;color:#aaa">'+(latest?'Current: '+latest+sc.label+' · target: '+sc.target+sc.label:'No data entered yet — target: '+sc.target+sc.label)+'</span></div>';
    }

    var monthCells = MONTHS.map(function(m, mi){
      var q = mQ(mi);
      var qc = Q_COLORS[q];
      var isCur = m === CUR_MONTH;
      var val = sc.months[m]||'';
      var note = sc.notes[m]||'';
      var hasVal = val!=='';
      return '<div class="sc-mc">'
        +'<div class="sc-mch"><span class="sc-mn2'+(isCur?' cur':'')+'">'+(isCur?m+' ←':m)+'</span>'
        +'<span class="sc-qt" style="background:'+qc.bg+';color:'+qc.c+'">'+q+'</span></div>'
        +'<div class="sc-mcb">'
        +'<input class="sc-val'+(hasVal?' f':'')+'" type="text" value="'+val+'" placeholder="—"'
        +' onchange="updateScorecard(this,'+sc.gn+',\''+m+'\')" oninput="this.className=\'sc-val f\'">'
        +'<textarea class="sc-notes'+(note?' f':'')+'" rows="2" placeholder="Notes..."'
        +' onchange="updateScorecardNotes(this,'+sc.gn+',\''+m+'\')">'+note+'</textarea>'
        +(hasVal&&sc.type==='cumulative'?'<div class="sc-mini"><div class="sc-mini-f" style="width:'+Math.min(100,Math.round(val/sc.target*100))+'%;background:'+sc.color+'"></div></div>':'')
        +'</div></div>';
    }).join('');

    return '<div class="scc" style="border-top:4px solid '+sc.color+'">'
      +'<div class="sch">'
      +'<div class="sc-lbl">2026 Goal '+sc.gn+' · '+sc.type+'</div>'
      +'<div class="sc-title">'+g.t+'</div>'
      +progressHtml
      +'<div class="sc-meta">Metric: '+sc.label+'</div></div>'
      +'<div class="sc-ms"><div class="sc-ms-lbl">Monthly entries</div>'
      +'<div class="sc-mg">'+monthCells+'</div></div></div>';
  }).join('');
}

// ═══════════════════════════════════════════════════════════
// RENDER ALL
// ═══════════════════════════════════════════════════════════
function renderAll(){
  renderPlan();
  renderWeeklyReview();
  renderMap('February','Q1');
  renderScorecard();
}

// ═══════════════════════════════════════════════════════════
// EVENT HANDLERS
// ═══════════════════════════════════════════════════════════
var VIEWS=['plan','map','weekly','scorecard'];
function show(n){
  VIEWS.forEach(function(v){
    document.getElementById('view-'+v).classList.toggle('active',v===n);
    document.getElementById('nb-'+v).classList.toggle('active',v===n);
  });
  if(n==='map') renderMap('February','Q1');
}

function cSel(s, goalN, delivTitle, taskId){
  var m={'Not Started':'ns','In Progress':'ip','Complete':'cp','On Hold':'oh'};
  var newStatus = m[s.value]||'ns';
  s.className='sel '+newStatus;
  var r=s.closest('.wtr');
  if(r){var c=r.querySelector('.wck');if(c)c.className='wck '+(m[s.value]||'');}
  // Update in-memory
  updateTaskStatus(goalN, delivTitle, taskId, newStatus);
}

function toggleTask(el, goalN, delivTitle, taskId){
  var cur = el.classList.contains('cp') ? 'cp' : el.classList.contains('ip') ? 'ip' : 'ns';
  var next = cur==='cp' ? 'ns' : cur==='ns' ? 'cp' : 'cp';
  el.className = 'wck ' + next;
  if(next==='cp'){
    el.innerHTML = '<svg width="10" height="8" viewBox="0 0 10 8" fill="none"><path d="M1 4L3.5 6.5L9 1" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  } else {
    el.innerHTML = '';
  }
  var sel = el.closest('.wtr')?.querySelector('select');
  if(sel){ sel.value = {ns:'Not Started',ip:'In Progress',cp:'Complete',oh:'On Hold'}[next]; sel.className='sel '+next; }
  updateTaskStatus(goalN, delivTitle, taskId, next);
}

function updateTaskStatus(goalN, delivTitle, taskId, status){
  // Write to weekData (per-week) not MD (plan-level)
  if(!weekData[viewingWeek]) weekData[viewingWeek] = {};
  weekData[viewingWeek][taskId] = weekData[viewingWeek][taskId] || {};
  weekData[viewingWeek][taskId].status = status;
  // Queue save to Weekly Review sheet
  var taskObj = null;
  MD.forEach(function(g){ g.delivs.forEach(function(d){ d.tasks.forEach(function(t){ if(t.id===taskId) taskObj=t; }); }); });
  if(taskObj) saveTaskStatus(taskId, goalN, delivTitle, taskObj.t, status, weekData[viewingWeek][taskId].count||null, '');
  // Refresh summary counts
  updateSummaryStrip();
}

function getWeekStatus(taskId){
  var wd = weekData[viewingWeek];
  return (wd && wd[taskId] && wd[taskId].status) ? wd[taskId].status : 'ns';
}

function getWeekCount(taskId){
  var wd = weekData[viewingWeek];
  return (wd && wd[taskId] && wd[taskId].count !== undefined && wd[taskId].count !== null) ? wd[taskId].count : null;
}

function updateSummaryStrip(){
  var allTasks = [];
  MD.forEach(function(g){ g.delivs.forEach(function(d){ if(!d.standing) d.tasks.filter(function(t){ return (t.week||CURRENT_WEEK_ISO)===viewingWeek; }).forEach(function(t){ allTasks.push(t); }); }); });
  var total = allTasks.length;
  var cp = allTasks.filter(function(t){ return getWeekStatus(t.id)==='cp'; }).length;
  var pct = total>0 ? Math.round(cp/total*100) : 0;
  document.getElementById('ws-total').textContent = total;
  document.getElementById('ws-complete').textContent = cp;
  document.getElementById('ws-pct').textContent = pct+'%';

  // Deliverables in progress = at least one started task but not all complete
  var delivIP = 0;
  MD.forEach(function(g){ g.delivs.forEach(function(d){
    if(d.standing) return;
    var statuses = d.tasks.map(function(t){ return getWeekStatus(t.id); });
    var hasSome = statuses.some(function(s){ return s==='ip'||s==='cp'; });
    var allDone = statuses.length > 0 && statuses.every(function(s){ return s==='cp'; });
    if(hasSome && !allDone) delivIP++;
  }); });
  document.getElementById('ws-inprog').textContent = delivIP;

  var sumBody = document.getElementById('sum-body');
  if(!sumBody) return;
  var goalPills = MD.map(function(g){
    var sc = SC.find(s=>s.gn===g.n);
    var pill = '';
    if(sc && sc.type==='cumulative'){
      var latest = latestMonthValue(sc);
      var pctG = sc.target > 0 ? Math.round(latest/sc.target*100) : 0;
      pill = '<div class="gpill" style="background:'+g.l+'"><div class="gpill-d" style="background:'+g.c+'"></div><span class="gpill-l" style="color:'+g.d+'">Goal '+g.n+' · '+pctG+'%</span></div>';
    } else if(sc && sc.type==='threshold'){
      var latest2 = latestMonthValue(sc);
      var met = latest2 >= sc.target;
      pill = '<div class="gpill" style="background:'+g.l+'"><div class="gpill-d" style="background:'+g.c+'"></div><span class="gpill-l" style="color:'+g.d+'">Goal '+g.n+' · '+(met?'On track':'Below target')+'</span></div>';
    }
    return pill;
  }).join('');
  sumBody.innerHTML = '<div class="sum-stat"><span class="sum-n">'+cp+'</span><span class="sum-t">of '+total+' tasks complete</span></div>'
    +'<div class="sum-stat"><span class="sum-n" style="color:var(--t)">'+delivIP+'</span><span class="sum-t">deliverables in progress</span></div>'
    +'<div class="sum-stat" style="border-right:none;padding-right:0;gap:6px">'+goalPills+'</div>';
}

function updRecurring(inp, taskId, target, goalN){
  var v = parseInt(inp.value)||0;
  var wrap = inp.closest('.rec-wrap');
  var st = wrap ? wrap.querySelector('.rec-status') : null;
  if(!inp.value){ inp.className='rec-inp'; if(st){st.textContent='';st.className='rec-status none';} }
  else if(target !== null){
    if(v>=target){ inp.className='rec-inp over'; if(st){st.textContent=v===target?'On target':'Over';st.className='rec-status over';}}
    else{ inp.className='rec-inp under'; if(st){st.textContent='Below';st.className='rec-status under';}}
  }
  // Write to weekData (per-week), not MD
  if(!weekData[viewingWeek]) weekData[viewingWeek] = {};
  weekData[viewingWeek][taskId] = weekData[viewingWeek][taskId] || {};
  weekData[viewingWeek][taskId].count = v;
  saveWeeklyData();
}

function updateScorecard(inp, goalN, month){
  var raw = inp.value.replace(/[^0-9.]/g,'');
  var val = raw === '' ? undefined : parseFloat(raw);
  var sc = SC.find(s=>s.gn===goalN);
  if(!sc) return;
  if(val !== undefined && !isNaN(val)){
    sc.months[month] = val;
  } else {
    delete sc.months[month];
    val = undefined;
  }
  saveScorecardVal(goalN, month, val);

  // Update mini-progress bar inside cell
  if(sc.type==='cumulative'){
    var cell = inp.closest('.sc-mcb');
    var miniEl = cell ? cell.querySelector('.sc-mini') : null;
    if(val === undefined || val === 0){
      if(miniEl) miniEl.remove();
    } else {
      var pct = Math.min(100, Math.round(val/sc.target*100));
      var mini = cell ? cell.querySelector('.sc-mini-f') : null;
      if(mini){ mini.style.width = pct+'%'; }
      else if(cell){
        var m = document.createElement('div');
        m.className='sc-mini';
        m.innerHTML='<div class="sc-mini-f" style="width:'+pct+'%;background:'+sc.color+'"></div>';
        cell.appendChild(m);
      }
    }
  }

  // Re-render the goal header (progress bar + percentage)
  var scc = inp.closest('.scc');
  if(!scc) return;
  var sch = scc.querySelector('.sch');
  if(!sch) return;
  var g = MD.find(g=>g.n===goalN);
  if(!g) return;

  var latest = latestMonthValue(sc);

  var oldPr = sch.querySelector('.sc-pr');
  var oldStatus = sch.querySelector('.sc-status');

  if(sc.type==='cumulative'){
    var overallPct = sc.target>0 ? Math.min(100,Math.round(latest/sc.target*100)) : 0;
    var newHtml = '<div class="sc-pr"><div class="sc-pct" style="color:'+sc.color+'">'+overallPct+'%</div>'
      +'<div class="sc-bw"><div class="sc-bar"><div class="sc-fill" style="width:'+overallPct+'%;background:'+sc.color+'"></div></div>'
      +'<div class="sc-tg"><span style="color:'+sc.color+';font-weight:600">'+latest.toLocaleString()+' '+sc.label+'</span>'
      +'<span>target: '+sc.target.toLocaleString()+'</span></div></div></div>';
    if(oldPr){ oldPr.outerHTML = newHtml; }
  } else if(sc.type==='threshold'){
    var met = latest >= sc.target;
    var newHtml2 = '<div class="sc-status"><span class="sc-status-pill '+(met?'hit':'miss')+'">'+(met?'✓ On target':'↗ Below target')+'</span>'
      +'<span style="font-size:.75rem;color:#aaa">'+(latest?'Current: '+latest+sc.label+' · target: '+sc.target+sc.label:'No data entered yet — target: '+sc.target+sc.label)+'</span></div>';
    if(oldStatus){ oldStatus.outerHTML = newHtml2; }
  }
}

function updateScorecardNotes(ta, goalN, month){
  var sc = SC.find(s=>s.gn===goalN);
  if(!sc) return;
  sc.notes[month] = ta.value;
  queueSave('Scorecard!A:Z', [[]]); // will be replaced by proper row save
  saveScorecardVal(goalN, month, sc.months[month]||'', ta.value);
}

function selM(btn, month, q){
  document.querySelectorAll('.mp').forEach(function(p){p.classList.remove('active');});
  btn.classList.add('active');
  document.getElementById('th-q').textContent=q+' Strategy';
  document.getElementById('th-d').textContent=month+' Deliverables';
  renderMap(month,q);
}

function shiftWeek(delta){
  viewingWeek = shiftWeekISO(viewingWeek, delta);
  // Initialize empty weekData for this week if not already loaded
  if(!weekData[viewingWeek]) weekData[viewingWeek] = {};
  renderWeeklyReview();
  if(isSignedIn()) loadWeeklyData(viewingWeek).then(renderWeeklyReview);
}

function selYear(y){
  // Could reload data for different year
  showToast('Year '+y+' selected');
}

// Inline strategy edit
function editStrategy(id){
  var el=document.getElementById(id);
  if(!el) return;
  var cur=el.textContent;
  var inp=document.createElement('input');
  inp.className='inline-edit';inp.value=cur;
  inp.style.width=Math.max(200,cur.length*7)+'px';
  el.parentNode.replaceChild(inp,el);
  inp.focus();inp.select();
  function save(){
    var span=document.createElement('span');
    span.className='so';span.id=id;span.textContent=inp.value||cur;
    span.onclick=function(){editStrategy(id);};
    inp.parentNode.replaceChild(span,inp);
    // Update in-memory and save
    var gn = parseInt(id.replace('s','').replace('-obj',''));
    var g = MD.find(g=>g.n===gn);
    if(g){ g.s=span.textContent; savePlan(); renderMap(document.querySelector('.mp.active')?.dataset?.month||'February','Q1'); }
  }
  inp.addEventListener('blur',save);
  inp.addEventListener('keydown',function(e){if(e.key==='Enter')inp.blur();if(e.key==='Escape'){inp.value=cur;inp.blur();}});
}

// Edit Task modal
function openEditTask(goalN, delivTitle, taskId){
  var g = MD.find(g=>g.n===goalN);
  if(!g) return;
  var d = g.delivs.find(function(d){ return d.t===delivTitle; });
  if(!d) return;
  var t = d.tasks.find(function(t){ return t.id===taskId; });
  if(!t) return;

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px';
  var box = document.createElement('div');
  box.style.cssText = 'background:#fff;border-radius:12px;padding:28px;width:100%;max-width:360px;box-shadow:0 12px 48px rgba(0,0,0,.2)';

  box.innerHTML = '<div style="font-family:var(--fd);font-size:1.1rem;color:var(--dt);margin-bottom:6px">Edit Task</div>'
    +'<div style="font-size:.78rem;color:#aaa;margin-bottom:18px">'+delivTitle+'</div>'
    +'<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Task</label>'
    +'<input id="et-title" value="'+t.t+'" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none"></div>'
    +'<div style="margin-bottom:20px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Week</label>'
    +buildWeekPicker(t.week||CURRENT_WEEK_ISO)+'</div>'
    +'<div style="display:flex;gap:8px;justify-content:flex-end">'
    +'<button id="et-delete" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ffcccc;background:none;color:#c0392b;font-family:var(--fb);font-size:.82rem;cursor:pointer;margin-right:auto">Delete</button>'
    +'<button id="et-cancel" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ddd;background:none;font-family:var(--fb);font-size:.82rem;cursor:pointer">Cancel</button>'
    +'<button id="et-save" style="padding:8px 18px;border-radius:6px;border:none;background:var(--t);color:#fff;font-family:var(--fb);font-size:.82rem;font-weight:600;cursor:pointer">Save</button>'
    +'</div>';

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  var inp = document.getElementById('et-title');
  inp.focus(); inp.select();
  inp.addEventListener('keydown', function(e){ if(e.key==='Enter') document.getElementById('et-save').click(); if(e.key==='Escape') overlay.remove(); });

  document.getElementById('et-cancel').onclick = function(){ overlay.remove(); };
  overlay.addEventListener('click', function(e){ if(e.target===overlay) overlay.remove(); });

  document.getElementById('et-save').onclick = function(){
    var title = inp.value.trim();
    if(!title){ inp.style.borderColor='#e55'; return; }
    t.t = title;
    t.week = document.getElementById('task-week-sel').value;
    overlay.remove();
    renderAll(); savePlan();
    showToast('Task updated');
  };

  document.getElementById('et-delete').onclick = function(){
    d.tasks = d.tasks.filter(function(tk){ return tk.id !== taskId; });
    overlay.remove();
    renderAll(); savePlan();
    showToast('Task deleted');
  };
}

// Shared week picker builder
function buildWeekPicker(selectedWeek){
  var weeks = [];
  var w = shiftWeekISO(CURRENT_WEEK_ISO, -2);
  for(var i=0; i<12; i++){
    weeks.push(w);
    w = shiftWeekISO(w, 1);
  }
  var opts = weeks.map(function(wk){
    var monday = isoWeekToMonday(wk);
    var dateStr = monday.toLocaleDateString('en-US', {month:'short', day:'numeric'});
    var label = (wk === CURRENT_WEEK_ISO ? 'This week · ' : '') + dateStr;
    return '<option value="'+wk+'"'+(wk===selectedWeek?' selected':'')+'>'+label+'</option>';
  }).join('');
  return '<select id="task-week-sel" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none">'+opts+'</select>';
}

// Schedule Task modal (click badge)
function openScheduleTask(taskId){
  var t = null, g = null, d = null;
  MD.forEach(function(og){ og.delivs.forEach(function(od){ od.tasks.forEach(function(ot){ if(ot.id===taskId){ t=ot; g=og; d=od; } }); }); });
  if(!t) return;

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px';
  var box = document.createElement('div');
  box.style.cssText = 'background:#fff;border-radius:12px;padding:28px;width:100%;max-width:320px;box-shadow:0 12px 48px rgba(0,0,0,.2)';

  box.innerHTML = '<div style="font-family:var(--fd);font-size:1.05rem;color:var(--dt);margin-bottom:4px">Schedule Task</div>'
    +'<div style="font-size:.78rem;color:#aaa;margin-bottom:16px">'+t.t+'</div>'
    +'<div style="margin-bottom:20px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Week</label>'
    +buildWeekPicker(t.week||CURRENT_WEEK_ISO)+'</div>'
    +'<div style="display:flex;gap:8px;justify-content:flex-end">'
    +'<button id="sw-cancel" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ddd;background:none;font-family:var(--fb);font-size:.82rem;cursor:pointer">Cancel</button>'
    +'<button id="sw-save" style="padding:8px 18px;border-radius:6px;border:none;background:var(--t);color:#fff;font-family:var(--fb);font-size:.82rem;font-weight:600;cursor:pointer">Save</button>'
    +'</div>';

  overlay.appendChild(box); document.body.appendChild(overlay);
  document.getElementById('sw-cancel').onclick = function(){ overlay.remove(); };
  overlay.addEventListener('click', function(e){ if(e.target===overlay) overlay.remove(); });
  document.getElementById('sw-save').onclick = function(){
    t.week = document.getElementById('task-week-sel').value;
    overlay.remove();
    renderAll(); savePlan();
    showToast('Task scheduled for '+weekBadgeLabel(t.week));
  };
}

// Add Task modal
function openAddTask(goalN, delivTitle){
  var g = MD.find(g=>g.n===goalN);
  if(!g) return;
  var d = g.delivs.find(function(d){ return d.t===delivTitle; });
  if(!d) return;

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px';
  var box = document.createElement('div');
  box.style.cssText = 'background:#fff;border-radius:12px;padding:28px;width:100%;max-width:360px;box-shadow:0 12px 48px rgba(0,0,0,.2)';

  box.innerHTML = '<div style="font-family:var(--fd);font-size:1.1rem;color:var(--dt);margin-bottom:6px">Add Task</div>'
    +'<div style="font-size:.78rem;color:#aaa;margin-bottom:18px">'+delivTitle+'</div>'
    +'<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Task</label>'
    +'<input id="at-title" placeholder="e.g. Draft outline" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none"></div>'
    +'<div style="margin-bottom:20px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Week</label>'
    +buildWeekPicker(CURRENT_WEEK_ISO)+'</div>'
    +'<div style="display:flex;gap:8px;justify-content:flex-end">'
    +'<button id="at-cancel" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ddd;background:none;font-family:var(--fb);font-size:.82rem;cursor:pointer">Cancel</button>'
    +'<button id="at-save" style="padding:8px 18px;border-radius:6px;border:none;background:var(--t);color:#fff;font-family:var(--fb);font-size:.82rem;font-weight:600;cursor:pointer">Add</button>'
    +'</div>';

  overlay.appendChild(box); document.body.appendChild(overlay);

  var inp = document.getElementById('at-title');
  inp.focus();
  inp.addEventListener('keydown', function(e){ if(e.key==='Enter') document.getElementById('at-save').click(); });

  document.getElementById('at-cancel').onclick = function(){ overlay.remove(); };
  overlay.addEventListener('click', function(e){ if(e.target===overlay) overlay.remove(); });

  document.getElementById('at-save').onclick = function(){
    var title = inp.value.trim();
    if(!title){ inp.style.borderColor='#e55'; return; }
    var newId = 'T'+Date.now();
    var week = document.getElementById('task-week-sel').value;
    d.tasks.push({ id: newId, t: title, s: 'ns', week: week });
    overlay.remove();
    renderAll(); savePlan();
    showToast('Task added for '+weekBadgeLabel(week));
  };
}

// Edit Goal modal
function openEditGoal(goalN){
  var g = MD.find(g=>g.n===goalN);
  if(!g) return;
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px';
  var box = document.createElement('div');
  box.style.cssText = 'background:#fff;border-radius:12px;padding:28px;width:100%;max-width:400px;box-shadow:0 12px 48px rgba(0,0,0,.2)';
  var types = ['cumulative','threshold','reduction','average','milestone','recurring'];
  var typeOpts = types.map(function(t){ return '<option'+(t===g.type?' selected':'')+'>'+t+'</option>'; }).join('');
  var fi = function(label,id,val){ return '<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">'+label+'</label><input id="'+id+'" value="'+(val||'')+'" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none"></div>'; };
  box.innerHTML = '<div style="font-family:var(--fd);font-size:1.1rem;color:var(--dt);margin-bottom:18px">Edit Goal '+(g.year||2026)+' · '+goalN+'</div>'
    +fi('Goal Title','eg-title',g.t)
    +fi('Target Number','eg-target',g.target)
    +fi('Metric Label','eg-label',g.label)
    +'<div style="margin-bottom:20px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Metric Type</label><select id="eg-type" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none">'+typeOpts+'</select></div>'
    +'<div style="display:flex;gap:8px;justify-content:flex-end"><button id="eg-cancel" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ddd;background:none;font-family:var(--fb);font-size:.82rem;cursor:pointer">Cancel</button><button id="eg-save" style="padding:8px 18px;border-radius:6px;border:none;background:var(--t);color:#fff;font-family:var(--fb);font-size:.82rem;font-weight:600;cursor:pointer">Save</button></div>';
  overlay.appendChild(box); document.body.appendChild(overlay);
  document.getElementById('eg-cancel').onclick = function(){ overlay.remove(); };
  overlay.addEventListener('click', function(e){ if(e.target===overlay) overlay.remove(); });
  document.getElementById('eg-save').onclick = function(){
    var title = document.getElementById('eg-title').value.trim();
    if(!title){ document.getElementById('eg-title').style.borderColor='#e55'; return; }
    g.t = title;
    g.target = parseFloat(document.getElementById('eg-target').value)||g.target;
    g.label = document.getElementById('eg-label').value.trim()||g.label;
    g.type = document.getElementById('eg-type').value;
    var sc = SC.find(s=>s.gn===goalN);
    if(sc){ sc.target=g.target; sc.type=g.type; sc.label=g.label; }
    overlay.remove();
    renderAll(); savePlan();
    showToast('Goal '+goalN+' updated');
  };
}

// Add Quarterly Strategy modal
function openAddStrategy(goalN){
  var g = MD.find(g=>g.n===goalN);
  if(!g) return;
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px';
  var box = document.createElement('div');
  box.style.cssText = 'background:#fff;border-radius:12px;padding:28px;width:100%;max-width:400px;box-shadow:0 12px 48px rgba(0,0,0,.2)';
  var quarters = ['Q1','Q2','Q3','Q4'];
  var qOpts = quarters.map(function(q){ return '<option>'+q+'</option>'; }).join('');
  box.innerHTML = '<div style="font-family:var(--fd);font-size:1.1rem;color:var(--dt);margin-bottom:6px">Add Quarterly Strategy</div>'
    +'<div style="font-size:.78rem;color:#aaa;margin-bottom:18px">Goal '+goalN+' · '+g.t+'</div>'
    +'<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Quarter</label><select id="qs-q" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none">'+qOpts+'</select></div>'
    +'<div style="margin-bottom:20px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Strategy Statement</label><textarea id="qs-s" rows="3" placeholder="e.g. Focus on building inbound channels" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none;resize:vertical"></textarea></div>'
    +'<div style="display:flex;gap:8px;justify-content:flex-end"><button id="qs-cancel" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ddd;background:none;font-family:var(--fb);font-size:.82rem;cursor:pointer">Cancel</button><button id="qs-save" style="padding:8px 18px;border-radius:6px;border:none;background:var(--t);color:#fff;font-family:var(--fb);font-size:.82rem;font-weight:600;cursor:pointer">Add</button></div>';
  overlay.appendChild(box); document.body.appendChild(overlay);
  document.getElementById('qs-cancel').onclick = function(){ overlay.remove(); };
  overlay.addEventListener('click', function(e){ if(e.target===overlay) overlay.remove(); });
  document.getElementById('qs-save').onclick = function(){
    var strat = document.getElementById('qs-s').value.trim();
    var q = document.getElementById('qs-q').value;
    if(!strat){ document.getElementById('qs-s').style.borderColor='#e55'; return; }
    // Store strategy by quarter — extend g with quarters object
    if(!g.quarters) g.quarters = {};
    g.quarters[q] = strat;
    if(q==='Q1') g.s = strat; // keep Q1 as the default shown
    overlay.remove();
    renderAll(); savePlan();
    showToast(q+' strategy added');
  };
}

// Edit Deliverable modal
function openEditDeliverable(goalN, delivTitle){
  var g = MD.find(g=>g.n===goalN);
  if(!g) return;
  var d = g.delivs.find(function(d){ return d.t===delivTitle; });
  if(!d) return;

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px';
  var box = document.createElement('div');
  box.style.cssText = 'background:#fff;border-radius:12px;padding:28px;width:100%;max-width:380px;box-shadow:0 12px 48px rgba(0,0,0,.2)';

  var colorOptions = [d.c, shadeColor(d.c,-15), shadeColor(d.c,-30)];
  var swatchHtml = colorOptions.map(function(col,i){
    return '<div onclick="selEDC('+i+')" id="edc-swatch-'+i+'" style="width:22px;height:22px;border-radius:50%;background:'+col+';cursor:pointer;border:3px solid '+(col===d.c?'#333':'transparent')+';transition:border .15s"></div>';
  }).join('');

  box.innerHTML = '<div style="font-family:var(--fd);font-size:1.1rem;color:var(--dt);margin-bottom:6px">Edit Deliverable</div>'
    +'<div style="font-size:.78rem;color:#aaa;margin-bottom:18px">Goal '+goalN+' · '+g.t+'</div>'
    +'<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Title</label>'
    +'<input id="ed-title" value="'+d.t+'" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none"></div>'
    +'<div style="margin-bottom:20px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:8px">Color</label>'
    +'<div style="display:flex;gap:10px">'+swatchHtml+'</div></div>'
    +'<div style="display:flex;gap:8px;justify-content:flex-end">'
    +'<button id="ed-delete" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ffcccc;background:none;color:#c0392b;font-family:var(--fb);font-size:.82rem;cursor:pointer;margin-right:auto">Delete</button>'
    +'<button id="ed-cancel" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ddd;background:none;font-family:var(--fb);font-size:.82rem;cursor:pointer">Cancel</button>'
    +'<button id="ed-save" style="padding:8px 18px;border-radius:6px;border:none;background:var(--t);color:#fff;font-family:var(--fb);font-size:.82rem;font-weight:600;cursor:pointer">Save</button>'
    +'</div>';

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  var selectedColor = colorOptions.indexOf(d.c) >= 0 ? colorOptions.indexOf(d.c) : 0;
  window.selEDC = function(i){
    document.getElementById('edc-swatch-'+selectedColor).style.border = '3px solid transparent';
    selectedColor = i;
    document.getElementById('edc-swatch-'+i).style.border = '3px solid #333';
  };

  var inp = document.getElementById('ed-title');
  inp.focus(); inp.select();
  inp.addEventListener('keydown', function(e){ if(e.key==='Enter') document.getElementById('ed-save').click(); if(e.key==='Escape') overlay.remove(); });

  document.getElementById('ed-cancel').onclick = function(){ overlay.remove(); };
  overlay.addEventListener('click', function(e){ if(e.target===overlay) overlay.remove(); });

  document.getElementById('ed-save').onclick = function(){
    var title = inp.value.trim();
    if(!title){ inp.style.borderColor='#e55'; return; }
    d.t = title;
    d.c = colorOptions[selectedColor];
    overlay.remove();
    renderAll(); savePlan();
    showToast('Deliverable updated');
  };

  document.getElementById('ed-delete').onclick = function(){
    if(!confirm('Delete "'+d.t+'" and all its tasks?')) return;
    g.delivs = g.delivs.filter(function(x){ return x.t !== delivTitle; });
    overlay.remove();
    renderAll(); savePlan();
    showToast('Deliverable deleted');
  };
}

// Add Standing Deliverable modal
function openAddStandingDeliverable(goalN){
  var g = MD.find(g=>g.n===goalN);
  if(!g) return;

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px';
  var box = document.createElement('div');
  box.style.cssText = 'background:#fff;border-radius:12px;padding:28px;width:100%;max-width:440px;max-height:90vh;overflow-y:auto;box-shadow:0 12px 48px rgba(0,0,0,.2)';

  var taskRows = [{name:'', type:'check', target:''}];

  window.asdToggleType = function(i){ saveInputs(); taskRows[i].type = taskRows[i].type==='check' ? 'count' : 'check'; render(); };
  window.asdRemoveRow = function(i){ saveInputs(); taskRows.splice(i,1); render(); };

  function renderTaskRow(tr, i){
    var isCount = tr.type === 'count';
    var toggleBtn = '<button onclick="asdToggleType('+i+')" style="display:flex;align-items:center;gap:4px;padding:5px 9px;border:1.5px solid '+(isCount?'var(--t)':'#ddd')+';border-radius:6px;background:'+(isCount?'var(--t)':'#fff')+';color:'+(isCount?'#fff':'#aaa')+';font-family:var(--fb);font-size:.72rem;font-weight:600;cursor:pointer;white-space:nowrap;flex-shrink:0">'+(isCount?'# Count':'\u2713 Check')+'</button>';
    var extraInput = isCount
      ? '<input class="asd-task-target" data-i="'+i+'" placeholder="Target" value="'+tr.target+'" type="number" min="0" style="width:64px;padding:7px 8px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.88rem;outline:none;text-align:center"><span style="font-size:.7rem;color:#aaa;white-space:nowrap">/ wk</span>'
      : '';
    return '<div style="display:flex;gap:6px;align-items:center;margin-bottom:8px">'
      +'<input class="asd-task-name" data-i="'+i+'" placeholder="Task name" value="'+tr.name+'" style="flex:1;min-width:0;padding:7px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.88rem;outline:none">'
      +toggleBtn
      +extraInput
      +(taskRows.length > 1 ? '<button onclick="asdRemoveRow('+i+')" style="background:none;border:none;color:#ccc;cursor:pointer;font-size:1rem;padding:2px 4px;flex-shrink:0">\u2715</button>' : '')
      +'</div>';
  }

  function render(){
    var taskHtml = taskRows.map(renderTaskRow).join('');
    box.innerHTML = '<div style="font-family:var(--fd);font-size:1.1rem;color:var(--dt);margin-bottom:4px">Add Standing Deliverable</div>'
      +'<div style="font-size:.78rem;color:#aaa;margin-bottom:18px">Goal '+goalN+' \u00b7 '+g.t+'</div>'
      +'<div style="margin-bottom:14px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Deliverable Name</label>'
      +'<input id="asd-name" placeholder="e.g. Review expenses" value="'+(box._name||'')+'" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none"></div>'
      +'<div style="margin-bottom:8px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Tasks \u2014 toggle \u2713 Check or # Count per task</label>'
      +taskHtml+'</div>'
      +'<button id="asd-add-row" style="background:none;border:1.5px dashed #ddd;border-radius:6px;padding:6px 14px;font-family:var(--fb);font-size:.82rem;color:#aaa;cursor:pointer;width:100%;margin-bottom:20px">+ Add task</button>'
      +'<div style="display:flex;gap:8px;justify-content:flex-end">'
      +'<button id="asd-cancel" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ddd;background:none;font-family:var(--fb);font-size:.82rem;cursor:pointer">Cancel</button>'
      +'<button id="asd-save" style="padding:8px 18px;border-radius:6px;border:none;background:var(--t);color:#fff;font-family:var(--fb);font-size:.82rem;font-weight:600;cursor:pointer">Add</button>'
      +'</div>';

    document.getElementById('asd-name').oninput = function(){ box._name = this.value; };
    document.getElementById('asd-add-row').onclick = function(){ saveInputs(); taskRows.push({name:'',type:'check',target:''}); render(); setTimeout(function(){ var els=box.querySelectorAll('.asd-task-name'); els[els.length-1].focus(); },50); };
    document.getElementById('asd-cancel').onclick = function(){ overlay.remove(); };
    document.getElementById('asd-save').onclick = save;
    box.querySelectorAll('.asd-task-name').forEach(function(el){ el.oninput = function(){ taskRows[parseInt(this.dataset.i)].name = this.value; }; });
    box.querySelectorAll('.asd-task-target').forEach(function(el){ el.oninput = function(){ taskRows[parseInt(this.dataset.i)].target = this.value; }; });
  }

  function saveInputs(){
    var nameEl = document.getElementById('asd-name');
    if(nameEl) box._name = nameEl.value;
    box.querySelectorAll('.asd-task-name').forEach(function(el){ taskRows[parseInt(el.dataset.i)].name = el.value; });
    box.querySelectorAll('.asd-task-target').forEach(function(el){ taskRows[parseInt(el.dataset.i)].target = el.value; });
  }

  function save(){
    saveInputs();
    var title = (box._name||'').trim();
    var nameEl = document.getElementById('asd-name');
    if(!title){ if(nameEl) nameEl.style.borderColor='#e55'; return; }
    var tasks = taskRows.filter(function(tr){ return tr.name.trim(); }).map(function(tr){
      var tgt = (tr.type==='count' && tr.target !== '') ? parseInt(tr.target)||null : null;
      return { id:'T'+Date.now()+Math.random().toString(36).slice(2,6), t:tr.name.trim(), s:'ns', type:tr.type, count:null, target:tgt };
    });
    if(tasks.length === 0){ showToast('Add at least one task'); return; }
    g.delivs.unshift({ c:g.c, t:title, standing:true, tasks:tasks });
    overlay.remove();
    renderAll(); savePlan();
    showToast('Standing deliverable added');
  }

  box._name = '';
  overlay.appendChild(box);
  document.body.appendChild(overlay);
  overlay.addEventListener('click', function(e){ if(e.target===overlay) overlay.remove(); });
  render();
  setTimeout(function(){ var el=document.getElementById('asd-name'); if(el) el.focus(); }, 50);
}


// Add Deliverable modal
function openAddDeliverable(goalN){
  var g = MD.find(g=>g.n===goalN);
  if(!g) return;

  // Build shade options from goal color
  var shades = [g.c, g.l ? shadeColor(g.c, -15) : g.c, shadeColor(g.c, -30)];
  var swatchHtml = [g.c, shadeColor(g.c,-15), shadeColor(g.c,-30)].map(function(col,i){
    return '<div onclick="selADC('+i+')" id="adc-swatch-'+i+'" style="width:22px;height:22px;border-radius:50%;background:'+col+';cursor:pointer;border:3px solid '+(i===0?'#333':'transparent')+';transition:border .15s"></div>';
  }).join('');

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px';
  var box = document.createElement('div');
  box.style.cssText = 'background:#fff;border-radius:12px;padding:28px;width:100%;max-width:380px;box-shadow:0 12px 48px rgba(0,0,0,.2)';

  var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  var curMonth = new Date().getMonth();
  var monthOpts = months.map(function(m,i){
    return '<option value="'+m+'"'+(i===curMonth?' selected':'')+'>'+m+'</option>';
  }).join('');

  box.innerHTML = '<div style="font-family:var(--fd);font-size:1.1rem;color:var(--dt);margin-bottom:6px">Add Monthly Deliverable</div>'
    +'<div style="font-size:.78rem;color:#aaa;margin-bottom:18px">Goal '+goalN+' · '+g.t+'</div>'
    +'<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Deliverable Title</label>'
    +'<input id="ad-title" placeholder="e.g. Launch email campaign" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none"></div>'
    +'<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Target Month</label>'
    +'<select id="ad-month" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none">'+monthOpts+'</select></div>'
    +'<div style="margin-bottom:20px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:8px">Color</label>'
    +'<div style="display:flex;gap:10px">'+swatchHtml+'</div></div>'
    +'<div style="display:flex;gap:8px;justify-content:flex-end">'
    +'<button id="ad-cancel" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ddd;background:none;font-family:var(--fb);font-size:.82rem;cursor:pointer">Cancel</button>'
    +'<button id="ad-save" style="padding:8px 18px;border-radius:6px;border:none;background:var(--t);color:#fff;font-family:var(--fb);font-size:.82rem;font-weight:600;cursor:pointer">Add</button>'
    +'</div>';

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  var selectedColor = 0;
  var colorOptions = [g.c, shadeColor(g.c,-15), shadeColor(g.c,-30)];
  window.selADC = function(i){
    document.getElementById('adc-swatch-'+selectedColor).style.border = '3px solid transparent';
    selectedColor = i;
    document.getElementById('adc-swatch-'+i).style.border = '3px solid #333';
  };

  document.getElementById('ad-cancel').onclick = function(){ overlay.remove(); };
  overlay.addEventListener('click', function(e){ if(e.target===overlay) overlay.remove(); });

  document.getElementById('ad-save').onclick = function(){
    var title = document.getElementById('ad-title').value.trim();
    if(!title){ document.getElementById('ad-title').style.borderColor='#e55'; return; }
    var month = document.getElementById('ad-month').value;
    var col = colorOptions[selectedColor];
    var newId = 'T'+(Date.now());
    g.delivs.push({ c: col, t: title, month: month, tasks: [] });
    overlay.remove();
    renderAll(); savePlan();
    showToast('Deliverable added to Goal '+goalN);
  };
}

function shadeColor(hex, pct){
  var n = parseInt(hex.slice(1),16);
  var r = Math.min(255,Math.max(0,(n>>16)+Math.round(2.55*pct)));
  var gv = Math.min(255,Math.max(0,((n>>8)&0xff)+Math.round(2.55*pct)));
  var b = Math.min(255,Math.max(0,(n&0xff)+Math.round(2.55*pct)));
  return '#'+((1<<24)+(r<<16)+(gv<<8)+b).toString(16).slice(1);
}

// Color palettes for new goals
var GOAL_PALETTES = [
  {c:'#27A8AF',l:'#E6F6F7',d:'#005A5E'},
  {c:'#D9BC52',l:'#FDF7E3',d:'#A07E00'},
  {c:'#39436e',l:'#ECEEF5',d:'#1E2545'},
  {c:'#C4694F',l:'#FAECEA',d:'#8B3620'},
  {c:'#6B8F71',l:'#EBF4EC',d:'#2E5733'},
  {c:'#8B6BB1',l:'#F2EDF8',d:'#4A2880'},
  {c:'#B05B8A',l:'#F8EDF4',d:'#6B1F4A'},
  {c:'#4A7FA5',l:'#E8F2F9',d:'#1C4F70'}
];

function openAddGoal(){
  var currentYear = new Date().getFullYear();
  var yearOpts = [currentYear, currentYear+1, currentYear+2].map(function(y){
    return '<option value="'+y+'"'+(y===currentYear?' selected':'')+'>'+y+'</option>';
  }).join('');
  var types = ['cumulative','threshold','reduction','average','milestone','recurring'];
  var typeOpts = types.map(function(t){
    return '<option value="'+t+'"'+(t==='cumulative'?' selected':'')+'>'+t+'</option>';
  }).join('');
  var swatchHtml = GOAL_PALETTES.map(function(p,i){
    return '<div onclick="selectGoalColor('+i+')" id="gc-swatch-'+i+'" style="width:24px;height:24px;border-radius:50%;background:'+p.c+';cursor:pointer;border:3px solid '+(i===0?'#333':'transparent')+';transition:border .15s"></div>';
  }).join('');

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px';
  var box = document.createElement('div');
  box.style.cssText = 'background:#fff;border-radius:12px;padding:28px;width:100%;max-width:400px;box-shadow:0 12px 48px rgba(0,0,0,.2);max-height:90vh;overflow-y:auto';

  var fi = function(label, id, val, placeholder){
    return '<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">'+label+'</label>'
      +'<input id="'+id+'" value="'+(val||'')+'" placeholder="'+(placeholder||'')+'" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none"></div>';
  };

  box.innerHTML = '<div style="font-family:var(--fd);font-size:1.1rem;color:var(--dt);margin-bottom:20px">Add New Goal</div>'
    +'<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Year</label>'
    +'<select id="ag-year" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none">'+yearOpts+'</select></div>'
    +fi('Goal Title','ag-title','','e.g. Grow newsletter to 5,000 subscribers')
    +fi('Target Number','ag-target','','e.g. 5000')
    +fi('Metric Label','ag-label','','e.g. subscribers')
    +'<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Metric Type</label>'
    +'<select id="ag-type" style="width:100%;box-sizing:border-box;padding:8px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none">'+typeOpts+'</select></div>'
    +fi('Q1 Strategy','ag-strategy','','e.g. Build awareness through partnerships')
    +'<div style="margin-bottom:20px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:8px">Color</label>'
    +'<div style="display:flex;gap:10px;flex-wrap:wrap">'+swatchHtml+'</div></div>'
    +'<div style="display:flex;gap:8px;justify-content:flex-end">'
    +'<button id="ag-cancel" style="padding:8px 18px;border-radius:6px;border:1.5px solid #ddd;background:none;font-family:var(--fb);font-size:.82rem;cursor:pointer">Cancel</button>'
    +'<button id="ag-save" style="padding:8px 18px;border-radius:6px;border:none;background:var(--t);color:#fff;font-family:var(--fb);font-size:.82rem;font-weight:600;cursor:pointer">Add Goal</button>'
    +'</div>';

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  var selectedPalette = 0;
  window.selectGoalColor = function(i){
    document.getElementById('gc-swatch-'+selectedPalette).style.border = '3px solid transparent';
    selectedPalette = i;
    document.getElementById('gc-swatch-'+i).style.border = '3px solid #333';
  };

  document.getElementById('ag-cancel').onclick = function(){ overlay.remove(); };
  overlay.addEventListener('click', function(e){ if(e.target===overlay) overlay.remove(); });

  document.getElementById('ag-save').onclick = function(){
    var title = document.getElementById('ag-title').value.trim();
    var target = parseFloat(document.getElementById('ag-target').value) || 0;
    var label = document.getElementById('ag-label').value.trim() || 'units';
    var type = document.getElementById('ag-type').value;
    var strategy = document.getElementById('ag-strategy').value.trim() || 'Define your Q1 strategy';
    var year = parseInt(document.getElementById('ag-year').value);
    if(!title){ document.getElementById('ag-title').style.borderColor='#e55'; return; }
    var pal = GOAL_PALETTES[selectedPalette];
    // Assign next available goal number
    var nextN = Math.max.apply(null, MD.map(function(g){return g.n;})) + 1;
    var newGoal = {
      n: nextN, year: year, t: title,
      c: pal.c, l: pal.l, d: pal.d,
      target: target, type: type, label: label,
      s: strategy, delivs: []
    };
    MD.push(newGoal);
    SC.push({gn: nextN, color: pal.c, gl: pal.l, type: type, label: label, target: target, months: {}, notes: {}});
    overlay.remove();
    renderAll(); savePlan();
    showToast('Goal '+nextN+' added');
  };
}

// Meta chip modal
function editMeta(goalN){
  var g = MD.find(g=>g.n===goalN);
  if(!g) return;
  var types=['cumulative','threshold','reduction','average','milestone','recurring'];
  var opts=types.map(function(t){return '<option'+(t===g.type?' selected':'')+'>'+t+'</option>';}).join('');
  var overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center';
  var box=document.createElement('div');
  box.style.cssText='background:#fff;border-radius:12px;padding:28px;min-width:320px;box-shadow:0 12px 48px rgba(0,0,0,.2)';
  box.innerHTML='<div style="font-family:var(--fd);font-size:1.1rem;color:var(--dt);margin-bottom:18px">Edit Goal Metrics</div>'
    +'<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Target</label>'
    +'<input id="meta-target" value="'+g.target+'" style="width:100%;padding:7px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none"></div>'
    +'<div style="margin-bottom:12px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Metric Label</label>'
    +'<input id="meta-label" value="'+g.label+'" style="width:100%;padding:7px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none"></div>'
    +'<div style="margin-bottom:20px"><label style="font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#aaa;display:block;margin-bottom:4px">Metric Type</label>'
    +'<select id="meta-type" style="width:100%;padding:7px 10px;border:1.5px solid #ddd;border-radius:6px;font-family:var(--fb);font-size:.9rem;outline:none">'+opts+'</select></div>'
    +'<div style="display:flex;gap:8px;justify-content:flex-end">'
    +'<button id="meta-cancel" style="padding:7px 16px;border-radius:6px;border:1.5px solid #ddd;background:none;font-family:var(--fb);font-size:.82rem;cursor:pointer">Cancel</button>'
    +'<button id="meta-save" style="padding:7px 16px;border-radius:6px;border:none;background:var(--t);color:#fff;font-family:var(--fb);font-size:.82rem;font-weight:600;cursor:pointer">Save</button>'
    +'</div>';
  overlay.appendChild(box);document.body.appendChild(overlay);
  document.getElementById('meta-cancel').onclick=function(){overlay.remove();};
  document.getElementById('meta-save').onclick=function(){
    g.target=parseFloat(document.getElementById('meta-target').value)||g.target;
    g.label=document.getElementById('meta-label').value||g.label;
    g.type=document.getElementById('meta-type').value||g.type;
    var sc=SC.find(s=>s.gn===goalN);
    if(sc){sc.target=g.target;sc.type=g.type;sc.label=g.label;}
    overlay.remove();
    renderAll(); savePlan();
    showToast('Goal '+goalN+' metrics updated');
  };
  overlay.addEventListener('click',function(e){if(e.target===overlay)overlay.remove();});
}

// ═══════════════════════════════════════════════════════════
// PRINT
// ═══════════════════════════════════════════════════════════
function printWeeklyReview(){
  // Open print preview page
  var win = window.open('', '_blank');
  if(!win) return;
  var monday = isoWeekToMonday(viewingWeek);
  var weekStr = monday.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  var allTasks = [];
  MD.forEach(function(g){ g.delivs.forEach(function(d){ d.tasks.filter(function(t){ return (t.week||CURRENT_WEEK_ISO)===viewingWeek; }).forEach(function(t){ allTasks.push({g,d,t}); }); }); });
  var cp = allTasks.filter(x=>getWeekStatus(x.t.id)==='cp').length;
  var ip = allTasks.filter(x=>getWeekStatus(x.t.id)==='ip').length;
  var ns = allTasks.filter(x=>getWeekStatus(x.t.id)==='ns').length;
  var total = allTasks.length;

  var statusLabel = {ns:'Not Started',ip:'In Progress',cp:'Complete',oh:'On Hold'};
  var statusColor = {ns:'#e8e8e8;color:#555',ip:'#FFF3CD;color:#7D5A00',cp:'#D6F0E0;color:#1A7A4A',oh:'#FFE4E4;color:#b22222'};

  var goalsHtml = MD.map(function(g){
    var delivsHtml = g.delivs.map(function(d){
      var tasksHtml = d.tasks.map(function(t){
        if(d.standing && (t.target !== null && t.target !== undefined)){
          var v = t.count||0, tgt = t.target;
          var chipColor = v>=tgt ? '#D6F0E0;color:#1A7A4A' : '#FFF3CD;color:#7D5A00';
          var chipTxt = v+' / '+tgt+(v>=tgt?' ✓':' ↗');
          return '<tr><td style="padding:5px 8px;font-size:11px;color:#444">'+t.t+'</td>'
            +'<td style="padding:5px 8px"><span style="font-size:9.5px;font-weight:600;padding:2px 7px;border-radius:10px;background:'+chipColor+'">'+chipTxt+'</span></td></tr>';
        }
        if(d.standing){ return '<tr><td style="padding:5px 8px;font-size:11px;color:#444">'+t.t+'</td><td style="padding:5px 8px"><span style="font-size:9.5px;color:#aaa">tracked</span></td></tr>'; }
        var ps=getWeekStatus(t.id); return '<tr><td style="padding:5px 8px"><input type="checkbox" style="margin-right:6px"'+(ps==='cp'?' checked':'')+'><span style="font-size:11px;color:#444'+(ps==='cp'?';text-decoration:line-through;color:#999':'')+'">'  +t.t+'</span></td>'
          +'<td style="padding:5px 8px"><span style="font-size:9.5px;font-weight:600;padding:2px 7px;border-radius:4px;background:'+statusColor[ps]+'">'+statusLabel[ps]+'</span></td></tr>';
      }).join('');
      return '<div style="margin-bottom:2px">'
        +'<div style="padding:5px 8px;display:flex;align-items:center;gap:6px;background:#fafafa;border-left:3px solid '+d.c+';border-bottom:1px solid #f0f0f0">'
        +'<div style="width:8px;height:8px;border-radius:50%;background:'+d.c+'"></div>'
        +'<span style="font-size:10.5px;font-weight:600;color:#003336">'+d.t+'</span>'
        +(d.standing?'<span style="font-size:8px;font-weight:700;background:#DCECEC;color:#005A5E;padding:1px 5px;border-radius:2px;text-transform:uppercase">Standing</span>':'')
        +'</div>'
        +'<table style="width:100%;border-collapse:collapse">'+tasksHtml+'</table></div>';
    }).join('');
    return '<div style="margin-bottom:10px;border:1px solid #eee;border-radius:6px;overflow:hidden">'
      +'<div style="padding:7px 10px;background:'+g.c+';display:flex;align-items:center;gap:8px">'
      +'<span style="font-family:Georgia,serif;font-size:12px;color:#fff;font-weight:600">Goal '+g.n+' · '+g.t+'</span></div>'
      +'<div style="padding:4px 8px;background:'+g.l+';border-bottom:1px solid #eee;font-size:9.5px;color:#666;font-style:italic">'+g.s+'</div>'
      +delivsHtml+'</div>';
  }).join('');

  win.document.write('<!DOCTYPE html><html><head><title>Weekly Review · '+weekStr+'</title>'
    +'<style>@page{size:8.5in 11in portrait;margin:.5in}body{font-family:\'DM Sans\',Arial,sans-serif;font-size:12px;color:#333}input[type=checkbox]{vertical-align:middle}</style>'
    +'</head><body>'
    +'<div style="border-bottom:2px solid #003336;padding-bottom:10px;margin-bottom:14px;display:flex;justify-content:space-between;align-items:flex-end">'
    +'<div><div style="font-size:8px;letter-spacing:.1em;text-transform:uppercase;color:#aaa;margin-bottom:2px">2026 STRATEGY TRACKER</div>'
    +'<div style="font-family:Georgia,serif;font-size:20px;color:#003336">Weekly Review</div>'
    +'<div style="font-size:10px;color:#999;margin-top:2px">'+weekStr+'</div></div>'
    +'<div style="display:flex;gap:16px;text-align:center">'
    +'<div><div style="font-family:Georgia,serif;font-size:18px;color:#003336">'+cp+'</div><div style="font-size:8px;text-transform:uppercase;color:#aaa">Complete</div></div>'
    +'<div><div style="font-family:Georgia,serif;font-size:18px;color:#D9BC52">'+ip+'</div><div style="font-size:8px;text-transform:uppercase;color:#aaa">In Progress</div></div>'
    +'<div><div style="font-family:Georgia,serif;font-size:18px;color:#888">'+ns+'</div><div style="font-size:8px;text-transform:uppercase;color:#aaa">Not Started</div></div>'
    +'<div><div style="font-family:Georgia,serif;font-size:18px;color:#27A8AF">'+total+'</div><div style="font-size:8px;text-transform:uppercase;color:#aaa">Total</div></div>'
    +'</div></div>'
    +goalsHtml
    +'<div style="margin-top:20px;padding-top:8px;border-top:1px solid #eee;display:flex;justify-content:space-between;font-size:9px;color:#aaa">'
    +'<span>Maya Smart · 2026 Strategy Tracker</span><span>Printed '+new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+'</span></div>'
    +'<script>window.onload=function(){window.print();}<\/script>'
    +'</body></html>');
  win.document.close();
}

function printStrategyOverview(){
  var win = window.open('', '_blank');
  if(!win) return;
  var now = new Date();
  var monthStr = now.toLocaleString('en-US',{month:'long',year:'numeric'});

  var statusColor = {ns:'background:#e8e8e8;color:#555',ip:'background:#FFF3CD;color:#7D5A00',cp:'background:#D6F0E0;color:#1A7A4A',oh:'background:#FFE4E4;color:#b22222'};
  var statusLabel = {ns:'Not Started',ip:'In Progress',cp:'Complete',oh:'On Hold'};

  var rowsHtml = MD.map(function(g){
    var sc = SC.find(s=>s.gn===g.n);
    var progressStr = '';
    if(sc && sc.type==='cumulative'){
      var latest = latestMonthValue(sc);
      var pct = Math.round(latest/sc.target*100);
      progressStr = pct+'%';
    } else { progressStr = '↗ Below target'; }

    var delivsHtml = g.delivs.map(function(d){
      return '<div style="display:flex;align-items:center;gap:5px;padding:3px 0;border-bottom:1px solid rgba(0,0,0,.05)">'
        +'<div style="width:7px;height:7px;border-radius:50%;background:'+d.c+';flex-shrink:0"></div>'
        +'<span style="font-size:10px;color:#333">'+d.t+'</span>'
        +(d.standing?'<span style="font-size:7.5px;background:#DCECEC;color:#005A5E;padding:1px 4px;border-radius:2px;text-transform:uppercase;font-weight:700">Standing</span>':'')
        +'</div>';
    }).join('');

    var tasksHtml = g.delivs.map(function(d,di){
      return d.tasks.map(function(t){
        if(d.standing && t.target!==null && t.target!==undefined){
          var v=t.count||0, tgt=t.target;
          var chipStyle=v>=tgt?'background:#D6F0E0;color:#1A7A4A':'background:#FFF3CD;color:#7D5A00';
          return '<div style="display:flex;align-items:center;gap:5px;padding:3px 0;border-bottom:1px solid #f5f5f5">'
            +'<div style="width:6px;height:6px;border-radius:50%;background:'+d.c+';flex-shrink:0"></div>'
            +'<span style="font-size:9.5px;color:#444;flex:1">'+t.t+'</span>'
            +'<span style="font-size:8.5px;font-weight:600;padding:1px 6px;border-radius:8px;'+chipStyle+'">'+v+' / '+tgt+(v>=tgt?' ✓':' ↗')+'</span></div>';
        }
        return '<div style="display:flex;align-items:center;gap:5px;padding:3px 0;border-bottom:1px solid #f5f5f5">'
          +'<div style="width:6px;height:6px;border-radius:50%;background:'+d.c+';flex-shrink:0"></div>'
          +'<span style="font-size:9.5px;color:#444;flex:1">'+t.t+'</span>'
          var ps2=getWeekStatus(t.id); +'<span style="font-size:8.5px;font-weight:600;padding:1px 6px;border-radius:4px;'+statusColor[ps2]+'">'+statusLabel[ps2]+'</span></div>';
      }).join('');
    }).join('');

    return '<tr style="border-bottom:2px solid #eee">'
      +'<td style="padding:10px 8px;background:'+g.l+';border-left:4px solid '+g.c+';vertical-align:middle;width:16%">'
      +'<div style="font-size:7.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:'+g.c+';margin-bottom:2px">GOAL '+g.n+'</div>'
      +'<div style="font-family:Georgia,serif;font-size:10.5px;color:#003336;line-height:1.3;margin-bottom:4px">'+g.t+'</div>'
      +'<span style="font-size:8.5px;font-weight:600;padding:2px 7px;border-radius:10px;background:'+g.l+';border:1px solid '+g.c+';color:'+g.c+'">'+progressStr+'</span></td>'
      +'<td style="padding:10px 8px;background:'+g.d+';vertical-align:middle;width:20%">'
      +'<div style="font-size:10px;font-style:italic;color:rgba(255,255,255,.9);line-height:1.4">'+g.s+'</div></td>'
      +'<td style="padding:10px 8px;background:'+g.l+';border-left:3px solid '+g.c+';vertical-align:middle;width:25%">'+delivsHtml+'</td>'
      +'<td style="padding:10px 8px;vertical-align:top">'+tasksHtml+'</td>'
      +'</tr>';
  }).join('');

  win.document.write('<!DOCTYPE html><html><head><title>Strategy Overview · '+monthStr+'</title>'
    +'<style>@page{size:11in 8.5in landscape;margin:.4in}body{font-family:\'DM Sans\',Arial,sans-serif;font-size:11px;color:#333}table{border-collapse:collapse;width:100%}th{background:#003336;color:#fff;font-size:8px;letter-spacing:.1em;text-transform:uppercase;padding:8px 10px;text-align:left}td{border-bottom:1px solid rgba(0,0,0,.05)}</style>'
    +'</head><body>'
    +'<div style="border-bottom:2px solid #003336;padding-bottom:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:flex-end">'
    +'<div><div style="font-size:7px;letter-spacing:.1em;text-transform:uppercase;color:#aaa;margin-bottom:2px">2026 STRATEGY TRACKER</div>'
    +'<div style="font-family:Georgia,serif;font-size:18px;color:#003336">Strategy Overview</div>'
    +'<div style="font-size:9px;color:#999;margin-top:1px">'+monthStr+'</div></div>'
    +'<span style="font-size:9px;color:#aaa">Maya Smart</span></div>'
    +'<table><thead><tr>'
    +'<th style="width:16%">2026 Goal</th><th style="width:20%">Q1 Strategy</th>'
    +'<th style="width:25%">February Deliverables</th><th>This Week\'s Tasks</th></tr></thead>'
    +'<tbody>'+rowsHtml+'</tbody></table>'
    +'<div style="margin-top:12px;padding-top:6px;border-top:1px solid #eee;display:flex;justify-content:space-between;font-size:8px;color:#aaa">'
    +'<span>Maya Smart · 2026 Strategy Tracker</span><span>Printed '+new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+'</span></div>'
    +'<script>window.onload=function(){window.print();}<\/script>'
    +'</body></html>');
  win.document.close();
}

// ═══════════════════════════════════════════════════════════
// UI UTILITIES
// ═══════════════════════════════════════════════════════════
function showLoading(msg){
  var el = document.getElementById('loading');
  el.style.display = 'flex';
  document.getElementById('loading-text').textContent = msg || 'Loading...';
}
function hideLoading(){ document.getElementById('loading').style.display = 'none'; }

var toastTimer;
function showToast(msg, isError){
  var el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast' + (isError?' err':'');
  clearTimeout(toastTimer);
  // Force reflow
  el.offsetHeight;
  el.classList.add('show');
  toastTimer = setTimeout(function(){ el.classList.remove('show'); }, 3000);
}

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════
async function init(){
  // Check for OAuth callback (implicit flow returns token in hash fragment)
  var hash = window.location.hash.substring(1);
  if(hash && new URLSearchParams(hash).get('access_token')){
    var ok = await handleOAuthCallback();
    if(ok){
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('app').style.display = '';
      updateAuthUI(true);
      showLoading('Loading your strategy...');
      await Promise.all([loadPlanData(), loadSalesData(), loadScorecardData(), loadWeeklyData(viewingWeek)]);
      hideLoading();
      renderAll();
      return;
    }
  }

  // Check stored token
  var storedToken = localStorage.getItem('access_token');
  var storedExpiry = localStorage.getItem('token_expiry');
  if(storedToken && storedExpiry && Date.now() < parseInt(storedExpiry)){
    accessToken = storedToken;
    tokenExpiry = parseInt(storedExpiry);
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app').style.display = '';
    updateAuthUI(true);
    showLoading('Loading your strategy...');
    try{
      await Promise.all([loadPlanData(), loadSalesData(), loadScorecardData(), loadWeeklyData(viewingWeek)]);
    }catch(e){ console.warn('Sheets load failed, using defaults', e); }
    hideLoading();
    renderAll();
    return;
  }

  // Try refresh token
  var rt = localStorage.getItem('refresh_token');
  if(rt){
    var ok = await refreshToken();
    if(ok){
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('app').style.display = '';
      updateAuthUI(true);
      showLoading('Loading your strategy...');
      try{
        await Promise.all([loadPlanData(), loadSalesData(), loadScorecardData(), loadWeeklyData(viewingWeek)]);
      }catch(e){ console.warn('Sheets load failed, using defaults', e); }
      hideLoading();
      renderAll();
      return;
    }
  }

  // Check if CLIENT_ID has been configured
  if(CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID'){
    // Demo mode — skip auth, show app with static data
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app').style.display = '';
    updateAuthUI(false);
    document.getElementById('auth-label').textContent = 'Demo mode';
    document.getElementById('auth-dot').className = 'hdr-dot';
    document.getElementById('auth-dot').style.background = '#f59e0b';
    renderAll();
    return;
  }

  // Show auth screen
  document.getElementById('auth-screen').style.display = '';
  document.getElementById('app').style.display = 'none';
}

init();

// Delegated handler for deliverable edit buttons (avoids inline escaping issues)
document.addEventListener('click', function(e){
  var btn = e.target.closest('.dh-edit');
  if(btn){
    var gn = parseInt(btn.dataset.gn);
    var dt = btn.dataset.dt;
    openEditDeliverable(gn, dt);
  }
});
</script>
</body>
</html>
